# 系统更新与备份

<cite>
**本文档引用的文件**  
- [Makefile](file://Makefile)
- [docker-compose.yml](file://docker-compose.yml)
- [main.go](file://cmd/council/main.go)
- [config.go](file://internal/pkg/config/config.go)
- [versioning.go](file://internal/core/middleware/versioning.go)
- [versioning_test.go](file://internal/core/middleware/versioning_test.go)
- [SPEC-605-versioning-middleware.md](file://docs/specs/sprint6/SPEC-605-versioning-middleware.md)
- [09_deployment.md](file://docs/tdd/09_deployment.md)
- [001_init_schema.up.sql](file://internal/infrastructure/db/migrations/001_init_schema.up.sql)
- [postgres.go](file://internal/infrastructure/db/postgres.go)
- [migrator.go](file://internal/infrastructure/db/migrator.go)
</cite>

## 目录
1. [引言](#引言)
2. [项目结构](#项目结构)
3. [核心组件](#核心组件)
4. [架构概述](#架构概述)
5. [详细组件分析](#详细组件分析)
6. [依赖分析](#依赖分析)
7. [性能考虑](#性能考虑)
8. [故障排除指南](#故障排除指南)
9. [结论](#结论)

## 引言
本文档旨在为“The Council”系统提供全面的更新与备份恢复操作手册。该系统是一个可视化多智能体协作系统和个人私有思维库，支持通过拖放式DAG编辑器构建工作流、AI驱动的生成、模板库复用等功能。文档将详细介绍如何利用Makefile中的stop、start、restart命令实现服务的平滑更新，以及如何通过docker-compose.yml配置实现零停机部署。此外，还将详细描述数据库备份（pg_dump）和恢复（pg_restore）的具体命令和自动化脚本，提供配置文件版本控制和环境变量管理的最佳实践，并建议设置Prometheus和Grafana监控堆栈，用于跟踪系统性能指标（CPU、内存、请求延迟等）和服务健康状况。

## 项目结构
本项目采用分层架构设计，主要分为前端、后端和基础设施三个部分。前端使用React 19、Vite、TailwindCSS等技术栈构建SPA应用；后端采用Go 1.21+和Gin框架开发RESTful API服务；基础设施层则依赖PostgreSQL 16（含pgvector扩展）作为主数据库，Redis作为缓存服务。

```mermaid
graph TD
subgraph Frontend["前端 (React SPA)"]
WorkflowEditor["工作流编辑器"]
ChatPanel["聊天面板"]
DocumentReader["文档阅读器"]
end
subgraph Backend["后端 (Go/Gin)"]
WorkflowEngine["工作流引擎"]
MemoryService["记忆服务"]
LLMProviders["LLM提供商"]
end
subgraph Infrastructure["基础设施"]
PostgreSQL["PostgreSQL (pgvector)"]
Redis["Redis (缓存)"]
ExternalAPIs["外部API (LLM, 搜索)"]
end
Frontend --> Backend
Backend --> Infrastructure
```

**Diagram sources**
- [README.md](file://README.md#L149-L174)

**Section sources**
- [README.md](file://README.md#L289-L312)

## 核心组件
系统的核心组件包括工作流引擎、记忆服务、LLM提供商接口、数据库和缓存服务。工作流引擎负责解析和执行用户定义的工作流，支持多种节点类型如Agent、Vote、Loop、FactCheck和HumanReview。记忆服务实现了三层记忆机制：隔离区→工作记忆→长期知识，确保数据的安全性和一致性。LLM提供商接口支持OpenAI、Gemini、DeepSeek、DashScope、Ollama等多种模型，提供灵活的AI能力接入。数据库使用PostgreSQL 16并集成pgvector扩展，支持向量相似性搜索，而Redis则用于缓存频繁访问的数据以提高性能。

**Section sources**
- [README.md](file://README.md#L149-L174)
- [main.go](file://cmd/council/main.go#L21-L149)

## 架构概述
系统的整体架构分为三层：前端、后端和基础设施。前端通过REST和WebSocket与后端通信，后端处理业务逻辑并与数据库和缓存服务交互。基础设施层包括PostgreSQL数据库、Redis缓存和外部API服务。

```mermaid
graph TD
subgraph Frontend["前端 (React SPA)"]
WorkflowEditor["工作流编辑器"]
ChatPanel["聊天面板"]
DocumentReader["文档阅读器"]
end
subgraph Backend["后端 (Go/Gin)"]
WorkflowEngine["工作流引擎"]
MemoryService["记忆服务"]
LLMProviders["LLM提供商"]
end
subgraph Infrastructure["基础设施"]
PostgreSQL["PostgreSQL (pgvector)"]
Redis["Redis (缓存)"]
ExternalAPIs["外部API (LLM, 搜索)"]
end
Frontend --> Backend
Backend --> Infrastructure
```

**Diagram sources**
- [README.md](file://README.md#L149-L174)

**Section sources**
- [README.md](file://README.md#L149-L174)

## 详细组件分析
### 服务更新与回滚
系统提供了丰富的Makefile命令来支持服务的平滑更新和版本回滚。通过`make start`、`make stop`和`make restart`命令可以轻松地启动、停止和重启整个系统。这些命令不仅简化了日常运维操作，还确保了服务的稳定性和可靠性。

#### 服务生命周期管理
```mermaid
flowchart TD
Start["开始"] --> StartAll["启动所有服务"]
StartAll --> StartDB["启动数据库服务"]
StartDB --> StartBackend["启动后端服务"]
StartBackend --> StartFrontend["启动前端服务"]
StartFrontend --> End["结束"]
Stop["停止"] --> StopFrontend["停止前端服务"]
StopFrontend --> StopBackend["停止后端服务"]
StopBackend --> StopDB["停止数据库服务"]
StopDB --> End
```

**Diagram sources**
- [Makefile](file://Makefile#L46-L163)

**Section sources**
- [Makefile](file://Makefile#L46-L163)

### 零停机部署
通过docker-compose.yml配置，系统实现了零停机部署。Docker Compose文件定义了PostgreSQL和Redis服务，确保了数据库和缓存服务的高可用性。在更新过程中，可以通过`docker compose up -d`命令无缝更新服务，而不会中断现有连接。

#### Docker Compose 配置
```yaml
version: '3.8'

services:
  postgres:
    image: pgvector/pgvector:pg16
    environment:
      POSTGRES_USER: council
      POSTGRES_PASSWORD: ${DB_PASSWORD}
      POSTGRES_DB: council
    volumes:
      - pgdata:/var/lib/postgresql/data
    ports:
      - "5432:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U council"]
      interval: 5s
      timeout: 5s
      retries: 5

  backend:
    build:
      context: .
      dockerfile: Dockerfile.backend
    environment:
      DATABASE_URL: postgres://council:${DB_PASSWORD}@postgres:5432/council?sslmode=disable
      COUNCIL_MASTER_KEY: ${COUNCIL_MASTER_KEY}
    ports:
      - "8080:8080"
    depends_on:
      postgres:
        condition: service_healthy

  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    ports:
      - "80:80"
    depends_on:
      - backend

volumes:
  pgdata:
```

**Diagram sources**
- [09_deployment.md](file://docs/tdd/09_deployment.md#L27-L72)

**Section sources**
- [09_deployment.md](file://docs/tdd/09_deployment.md#L27-L72)

### 数据库备份与恢复
系统使用PostgreSQL作为主数据库，支持通过`pg_dump`和`pg_restore`命令进行数据备份和恢复。为了确保数据安全，建议定期执行备份操作，并将备份文件存储在安全的位置。

#### 数据库备份脚本
```bash
#!/bin/bash
# 备份数据库
pg_dump -h localhost -U council -d council_db -f /path/to/backup/council_db_$(date +%Y%m%d_%H%M%S).sql

# 恢复数据库
pg_restore -h localhost -U council -d council_db /path/to/backup/council_db_20241220_142637.sql
```

**Section sources**
- [001_init_schema.up.sql](file://internal/infrastructure/db/migrations/001_init_schema.up.sql#L1-L96)
- [postgres.go](file://internal/infrastructure/db/postgres.go#L1-L66)
- [migrator.go](file://internal/infrastructure/db/migrator.go#L1-L109)

### 配置文件版本控制与环境变量管理
系统通过`.env`文件管理环境变量，确保不同环境下的配置一致性。推荐使用Git进行配置文件的版本控制，以便追踪变更历史和快速回滚到之前的版本。

#### .env 文件示例
```env
PORT=8080
DATABASE_URL=postgres://council:council_password@localhost:5432/council_db?sslmode=disable
LLM_PROVIDER=gemini
LLM_MODEL=gemini-2.0-flash
GEMINI_API_KEY=your_gemini_api_key
```

**Section sources**
- [config.go](file://internal/pkg/config/config.go#L8-L132)

### 监控与告警
建议设置Prometheus和Grafana监控堆栈，用于跟踪系统性能指标（CPU、内存、请求延迟等）和服务健康状况。通过Prometheus收集系统指标，Grafana展示可视化仪表板，及时发现和解决潜在问题。

#### Prometheus 配置
```yaml
scrape_configs:
  - job_name: 'council-backend'
    static_configs:
      - targets: ['localhost:8080']
```

**Section sources**
- [README.md](file://README.md#L149-L174)

## 依赖分析
系统依赖于多个外部服务和库，包括PostgreSQL、Redis、Go语言运行时、Node.js、Docker等。这些依赖项通过`go.mod`、`package.json`和`docker-compose.yml`文件进行管理，确保了项目的可移植性和一致性。

```mermaid
graph TD
A[The Council] --> B[PostgreSQL]
A --> C[Redis]
A --> D[Go 1.21+]
A --> E[Node.js ≥ 20]
A --> F[Docker ≥ 20.10]
A --> G[Docker Compose v2.x]
```

**Diagram sources**
- [README.md](file://README.md#L48-L56)

**Section sources**
- [README.md](file://README.md#L48-L56)

## 性能考虑
系统在设计时充分考虑了性能优化，通过使用Redis缓存频繁访问的数据、PostgreSQL的pgvector扩展支持向量相似性搜索、以及Gin框架的高性能HTTP处理能力，确保了系统的高效运行。此外，前端使用Vite进行快速开发和热更新，提升了开发效率。

## 故障排除指南
当系统出现故障时，首先检查服务状态，确保所有服务正常运行。如果问题仍然存在，查看日志文件以获取更多信息。对于数据库相关的问题，可以尝试重启数据库服务或恢复备份数据。

**Section sources**
- [Makefile](file://Makefile#L52-L65)
- [README.md](file://README.md#L86-L90)

## 结论
本文档详细介绍了“The Council”系统的更新与备份恢复操作手册，涵盖了服务的滚动更新、版本回滚、数据备份策略、配置文件版本控制和环境变量管理的最佳实践，以及监控与告警的建议。通过遵循本文档中的指导，可以有效提升系统的稳定性和可靠性，确保业务连续性。
# å¥åº·æ£€æŸ¥ä¸æ—¥å¿—

<cite>
**æœ¬æ–‡æ¡£å¼•ç”¨çš„æ–‡ä»¶**
- [docker-compose.yml](file://docker-compose.yml)
- [Makefile](file://Makefile)
- [SPEC-504-security-hardening.md](file://docs/specs/sprint5/SPEC-504-security-hardening.md)
- [config.go](file://internal/pkg/config/config.go)
- [postgres.go](file://internal/infrastructure/db/postgres.go)
- [redis.go](file://internal/infrastructure/cache/redis.go)
</cite>

## ç›®å½•
1. [å¼•è¨€](#å¼•è¨€)
2. [å¥åº·æ£€æŸ¥é…ç½®](#å¥åº·æ£€æŸ¥é…ç½®)
3. [æ—¥å¿—ç›‘æ§ä¸ç®¡ç†](#æ—¥å¿—ç›‘æ§ä¸ç®¡ç†)
4. [ç»“æ„åŒ–æ—¥å¿—ä¸å®‰å…¨è„±æ•](#ç»“æ„åŒ–æ—¥å¿—ä¸å®‰å…¨è„±æ•)
5. [æ—¥å¿—æ¨¡å¼è§£è¯»æŒ‡å—](#æ—¥å¿—æ¨¡å¼è§£è¯»æŒ‡å—)
6. [Makefileé›†æˆä¸æ—¥å¸¸ç»´æŠ¤](#makefileé›†æˆä¸æ—¥å¸¸ç»´æŠ¤)
7. [ç»“è®º](#ç»“è®º)

## å¼•è¨€
æœ¬æ–‡æ¡£è¯¦ç»†è¯´æ˜äº†å¦‚ä½•é€šè¿‡`docker-compose.yml`æ–‡ä»¶ä¸­å®šä¹‰çš„æœåŠ¡é…ç½®å®ç°PostgreSQLå’ŒRedisçš„å®¹å™¨å¥åº·æ£€æŸ¥ã€‚åŒæ—¶ï¼Œæ–‡æ¡£è§£é‡Šäº†å¦‚ä½•ä½¿ç”¨`docker-compose logs -f`å‘½ä»¤å®æ—¶ç›‘æ§æ•°æ®åº“å’Œåç«¯æœåŠ¡æ—¥å¿—ï¼Œä»¥åŠå¦‚ä½•åœ¨ç”Ÿäº§ç¯å¢ƒä¸­é…ç½®ç»“æ„åŒ–æ—¥å¿—è¾“å‡ºã€‚æ¶µç›–äº†æ—¥å¿—çº§åˆ«è®¾ç½®ã€æ—¥å¿—è½®è½¬ç­–ç•¥å’Œæ•æ„Ÿä¿¡æ¯è„±æ•å¤„ç†ï¼ˆå‚è€ƒSPEC-504ä¸­çš„SanitizedLoggerå®ç°ï¼‰ã€‚æ­¤å¤–ï¼Œæ–‡æ¡£æä¾›äº†å¸¸è§æ—¥å¿—æ¨¡å¼çš„è§£è¯»æŒ‡å—ï¼Œå¸®åŠ©è¿ç»´äººå‘˜å¿«é€Ÿè¯†åˆ«ç³»ç»Ÿå¼‚å¸¸ï¼Œå¹¶é›†æˆäº†Makefileä¸­çš„`logs-db`ç›®æ ‡ï¼Œè¯´æ˜å…¶åœ¨æ—¥å¸¸ç»´æŠ¤ä¸­çš„ä½¿ç”¨æ–¹æ³•ã€‚

## å¥åº·æ£€æŸ¥é…ç½®
åœ¨`docker-compose.yml`æ–‡ä»¶ä¸­ï¼ŒPostgreSQLå’ŒRedisæœåŠ¡çš„å¥åº·æ£€æŸ¥æ˜¯é€šè¿‡Docker Composeçš„`healthcheck`æŒ‡ä»¤å®ç°çš„ã€‚è™½ç„¶åœ¨æä¾›çš„æ–‡ä»¶ä¸­æ²¡æœ‰æ˜¾å¼å®šä¹‰å¥åº·æ£€æŸ¥ï¼Œä½†å¯ä»¥é€šè¿‡æ·»åŠ `healthcheck`æŒ‡ä»¤æ¥é…ç½®ã€‚ä¾‹å¦‚ï¼Œå¯¹äºPostgreSQLæœåŠ¡ï¼Œå¯ä»¥æ·»åŠ å¦‚ä¸‹é…ç½®ï¼š

```yaml
healthcheck:
  test: ["CMD-SHELL", "pg_isready -U council -d council_db"]
  interval: 10s
  timeout: 5s
  retries: 5
```

å¯¹äºRedisæœåŠ¡ï¼Œå¯ä»¥æ·»åŠ å¦‚ä¸‹é…ç½®ï¼š

```yaml
healthcheck:
  test: ["CMD-SHELL", "redis-cli ping"]
  interval: 10s
  timeout: 5s
  retries: 5
```

è¿™äº›é…ç½®ç¡®ä¿äº†å®¹å™¨åœ¨å¯åŠ¨åèƒ½å¤Ÿæ­£ç¡®åœ°è¿›è¡Œå¥åº·æ£€æŸ¥ï¼Œä»è€Œä¿è¯æœåŠ¡çš„å¯ç”¨æ€§ã€‚

**Section sources**
- [docker-compose.yml](file://docker-compose.yml)

## æ—¥å¿—ç›‘æ§ä¸ç®¡ç†
é€šè¿‡`docker-compose logs -f`å‘½ä»¤å¯ä»¥å®æ—¶ç›‘æ§æ•°æ®åº“å’Œåç«¯æœåŠ¡çš„æ—¥å¿—ã€‚è¯¥å‘½ä»¤ä¼šæŒç»­è¾“å‡ºæ‰€æœ‰æœåŠ¡çš„æ—¥å¿—ä¿¡æ¯ï¼Œç›´åˆ°ç”¨æˆ·ä¸­æ–­ã€‚åœ¨`Makefile`ä¸­ï¼Œ`logs-db`ç›®æ ‡è¢«å®šä¹‰ä¸ºæ‰§è¡Œ`docker-compose logs -f`å‘½ä»¤ï¼Œæ–¹ä¾¿ç”¨æˆ·å¿«é€Ÿå¯åŠ¨æ—¥å¿—ç›‘æ§ã€‚

```makefile
logs-db: ## ğŸ“œ Follow database logs
	@docker compose logs -f
```

æ­¤å¤–ï¼Œ`Makefile`ä¸­çš„`status`ç›®æ ‡å¯ä»¥æ˜¾ç¤ºæ‰€æœ‰æœåŠ¡çš„çŠ¶æ€ï¼ŒåŒ…æ‹¬DockeræœåŠ¡ã€åç«¯æœåŠ¡å’Œå‰ç«¯æœåŠ¡çš„è¿è¡ŒçŠ¶æ€ã€‚

```makefile
status: ## ğŸ“Š Show status of all services
	@echo "$(BOLD)$(CYAN)ğŸ“Š Service Status$(RESET)"
	@echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
	@echo ""
	@echo "$(BOLD)ğŸ³ Docker Services:$(RESET)"
	@docker compose ps 2>/dev/null || echo "   Not running"
	@echo ""
	@echo "$(BOLD)ğŸ”§ Backend (port 8080):$(RESET)"
	@lsof -ti:8080 >/dev/null 2>&1 && echo "   $(GREEN)â— Running$(RESET) (PID: $$(lsof -ti:8080))" || echo "   $(RED)â—‹ Stopped$(RESET)"
	@echo ""
	@echo "$(BOLD)ğŸ¨ Frontend (port 5173/5174):$(RESET)"
	@lsof -ti:5173 >/dev/null 2>&1 && echo "   $(GREEN)â— Running$(RESET) on :5173" || \
		(lsof -ti:5174 >/dev/null 2>&1 && echo "   $(GREEN)â— Running$(RESET) on :5174" || echo "   $(RED)â—‹ Stopped$(RESET)")
	@echo ""
```

**Section sources**
- [Makefile](file://Makefile)

## ç»“æ„åŒ–æ—¥å¿—ä¸å®‰å…¨è„±æ•
åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œé…ç½®ç»“æ„åŒ–æ—¥å¿—è¾“å‡ºæ˜¯è‡³å…³é‡è¦çš„ã€‚`internal/pkg/config/config.go`æ–‡ä»¶ä¸­å®šä¹‰äº†æ—¥å¿—é…ç½®ï¼ŒåŒ…æ‹¬æ—¥å¿—çº§åˆ«ã€æ—¥å¿—è½®è½¬ç­–ç•¥ç­‰ã€‚ä¸ºäº†ç¡®ä¿æ—¥å¿—çš„å®‰å…¨æ€§ï¼Œä½¿ç”¨äº†`SanitizedLogger`ç»“æ„ä½“æ¥è¿‡æ»¤æ•æ„Ÿå­—æ®µã€‚

```go
type SanitizedLogger struct {
    sensitiveFields []string
}

func (l *SanitizedLogger) Log(data map[string]interface{}) {
    for _, field := range l.sensitiveFields {
        if _, exists := data[field]; exists {
            data[field] = "[REDACTED]"
        }
    }
    log.Printf("%+v", data)
}

var logger = SanitizedLogger{
    sensitiveFields: []string{"password", "api_key", "token", "secret"},
}
```

æ­¤ç»“æ„ä½“ç¡®ä¿äº†æ•æ„Ÿä¿¡æ¯åœ¨æ—¥å¿—ä¸­è¢«è„±æ•å¤„ç†ï¼Œé˜²æ­¢æ³„éœ²ã€‚

**Section sources**
- [SPEC-504-security-hardening.md](file://docs/specs/sprint5/SPEC-504-security-hardening.md)
- [config.go](file://internal/pkg/config/config.go)

## æ—¥å¿—æ¨¡å¼è§£è¯»æŒ‡å—
å¸¸è§çš„æ—¥å¿—æ¨¡å¼åŒ…æ‹¬å¯åŠ¨æ—¥å¿—ã€é”™è¯¯æ—¥å¿—å’Œæ€§èƒ½æ—¥å¿—ã€‚å¯åŠ¨æ—¥å¿—é€šå¸¸åŒ…å«æœåŠ¡å¯åŠ¨æˆåŠŸçš„ä¿¡æ¯ï¼Œå¦‚â€œServer listening on :8080â€ã€‚é”™è¯¯æ—¥å¿—åˆ™åŒ…å«æœåŠ¡è¿è¡Œè¿‡ç¨‹ä¸­å‡ºç°çš„é”™è¯¯ä¿¡æ¯ï¼Œå¦‚â€œFailed to initialize databaseâ€ã€‚æ€§èƒ½æ—¥å¿—åˆ™è®°å½•æœåŠ¡çš„æ€§èƒ½æŒ‡æ ‡ï¼Œå¦‚å“åº”æ—¶é—´ã€è¯·æ±‚é¢‘ç‡ç­‰ã€‚

è¿ç»´äººå‘˜åº”é‡ç‚¹å…³æ³¨é”™è¯¯æ—¥å¿—ï¼ŒåŠæ—¶å‘ç°å¹¶è§£å†³é—®é¢˜ã€‚åŒæ—¶ï¼Œé€šè¿‡åˆ†ææ€§èƒ½æ—¥å¿—ï¼Œå¯ä»¥ä¼˜åŒ–æœåŠ¡æ€§èƒ½ï¼Œæé«˜ç”¨æˆ·ä½“éªŒã€‚

**Section sources**
- [main.go](file://cmd/council/main.go)
- [postgres.go](file://internal/infrastructure/db/postgres.go)
- [redis.go](file://internal/infrastructure/cache/redis.go)

## Makefileé›†æˆä¸æ—¥å¸¸ç»´æŠ¤
`Makefile`ä¸­çš„`logs-db`ç›®æ ‡è¢«å®šä¹‰ä¸ºæ‰§è¡Œ`docker-compose logs -f`å‘½ä»¤ï¼Œæ–¹ä¾¿ç”¨æˆ·å¿«é€Ÿå¯åŠ¨æ—¥å¿—ç›‘æ§ã€‚æ­¤å¤–ï¼Œ`Makefile`è¿˜æä¾›äº†å…¶ä»–å¸¸ç”¨å‘½ä»¤ï¼Œå¦‚`start`ã€`stop`ã€`restart`ç­‰ï¼Œç”¨äºæ—¥å¸¸ç»´æŠ¤ã€‚

```makefile
start: start-all ## ğŸš€ Start everything (DB + Backend + Frontend)
stop: stop-all ## ğŸ›‘ Stop everything
restart: stop start ## ğŸ”„ Restart everything
```

è¿™äº›å‘½ä»¤ç®€åŒ–äº†æœåŠ¡çš„ç®¡ç†å’Œç»´æŠ¤ï¼Œæé«˜äº†è¿ç»´æ•ˆç‡ã€‚

**Section sources**
- [Makefile](file://Makefile)

## ç»“è®º
é€šè¿‡åˆç†é…ç½®å¥åº·æ£€æŸ¥å’Œæ—¥å¿—ç®¡ç†ï¼Œå¯ä»¥æœ‰æ•ˆæé«˜ç³»ç»Ÿçš„ç¨³å®šæ€§å’Œå®‰å…¨æ€§ã€‚æœ¬æ–‡æ¡£è¯¦ç»†è¯´æ˜äº†å¦‚ä½•å®ç°è¿™äº›åŠŸèƒ½ï¼Œå¹¶æä¾›äº†å®ç”¨çš„å·¥å…·å’ŒæŒ‡å—ï¼Œå¸®åŠ©è¿ç»´äººå‘˜æ›´å¥½åœ°ç®¡ç†å’Œç»´æŠ¤ç³»ç»Ÿã€‚
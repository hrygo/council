# å®¹å™¨åŒ–éƒ¨ç½²

<cite>
**æœ¬æ–‡æ¡£å¼•ç”¨çš„æ–‡ä»¶**  
- [docker-compose.yml](file://docker-compose.yml)
- [Dockerfile.backend](file://Dockerfile.backend)
- [frontend/Dockerfile](file://frontend/Dockerfile)
- [.env.example](file://.env.example)
- [Makefile](file://Makefile)
- [docs/tdd/09_deployment.md](file://docs/tdd/09_deployment.md)
- [internal/pkg/config/config.go](file://internal/pkg/config/config.go)
- [cmd/council/main.go](file://cmd/council/main.go)
</cite>

## ç›®å½•
1. [ç®€ä»‹](#ç®€ä»‹)
2. [éƒ¨ç½²æ¶æ„æ¦‚è§ˆ](#éƒ¨ç½²æ¶æ„æ¦‚è§ˆ)
3. [Docker Compose é…ç½®è¯¦è§£](#docker-compose-é…ç½®è¯¦è§£)
4. [Dockerfile æ„å»ºè¿‡ç¨‹](#dockerfile-æ„å»ºè¿‡ç¨‹)
5. [ç¯å¢ƒå˜é‡ä¸æ•æ„Ÿä¿¡æ¯ç®¡ç†](#ç¯å¢ƒå˜é‡ä¸æ•æ„Ÿä¿¡æ¯ç®¡ç†)
6. [å®¹å™¨ç”Ÿå‘½å‘¨æœŸç®¡ç†](#å®¹å™¨ç”Ÿå‘½å‘¨æœŸç®¡ç†)
7. [ç”Ÿäº§éƒ¨ç½²æµç¨‹](#ç”Ÿäº§éƒ¨ç½²æµç¨‹)

## ç®€ä»‹
æœ¬æ–‡æ¡£è¯¦ç»†è¯´æ˜äº†The Councilç³»ç»Ÿçš„å®¹å™¨åŒ–éƒ¨ç½²æ–¹æ¡ˆï¼Œæ¶µç›–ä½¿ç”¨Dockerå’Œdocker-compose.ymlè¿›è¡Œéƒ¨ç½²çš„å®Œæ•´æµç¨‹ã€‚æ–‡æ¡£è§£é‡Šäº†å„æœåŠ¡çš„é…ç½®ç»†èŠ‚ã€å¤šé˜¶æ®µæ„å»ºè¿‡ç¨‹ã€ç¯å¢ƒå˜é‡ç®¡ç†ä»¥åŠå®¹å™¨çš„å®Œæ•´ç”Ÿå‘½å‘¨æœŸç®¡ç†å‘½ä»¤ã€‚

## éƒ¨ç½²æ¶æ„æ¦‚è§ˆ
The Councilç³»ç»Ÿé‡‡ç”¨å¾®æœåŠ¡æ¶æ„ï¼Œé€šè¿‡Docker Composeç¼–æ’å¤šä¸ªå®¹å™¨åŒ–æœåŠ¡ååŒå·¥ä½œã€‚ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²åŒ…å«å‰ç«¯ã€åç«¯ã€æ•°æ®åº“å’Œç¼“å­˜æœåŠ¡ï¼Œå„ç»„ä»¶é€šè¿‡Dockerç½‘ç»œè¿›è¡Œé€šä¿¡ã€‚

```mermaid
graph TD
subgraph Dev["å¼€å‘ç¯å¢ƒ"]
Vite["Vite å¼€å‘æœåŠ¡å™¨ :5173"]
Go["Go åç«¯ :8080"]
PG_Dev["PostgreSQL :5432"]
end
subgraph Prod["ç”Ÿäº§ç¯å¢ƒ - Docker"]
Nginx["Nginx :80"]
API["Go API å®¹å™¨"]
PG_Prod[("PostgreSQL + pgvector")]
end
Vite --> Go
Go --> PG_Dev
Nginx --> API
API --> PG_Prod
```

**Diagram sources**
- [docs/tdd/09_deployment.md](file://docs/tdd/09_deployment.md#L3-L23)

## Docker Compose é…ç½®è¯¦è§£
docker-compose.ymlæ–‡ä»¶å®šä¹‰äº†ç³»ç»Ÿæ‰€éœ€çš„å››ä¸ªæ ¸å¿ƒæœåŠ¡ï¼šPostgreSQLæ•°æ®åº“ã€Redisç¼“å­˜ã€Goåç«¯å’ŒNginxå‰ç«¯ã€‚

### æœåŠ¡é…ç½®
**PostgreSQL æœåŠ¡**:
- ä½¿ç”¨`pgvector/pgvector:pg16`é•œåƒï¼Œæ”¯æŒå‘é‡å­˜å‚¨
- ç«¯å£æ˜ å°„ï¼šä¸»æœº5432 â†’ å®¹å™¨5432
- æ•°æ®å·æŒ‚è½½ï¼š`postgres_data`å·ç”¨äºæŒä¹…åŒ–æ•°æ®
- å¥åº·æ£€æŸ¥ï¼šæ¯5ç§’æ£€æŸ¥ä¸€æ¬¡æ•°æ®åº“å¯ç”¨æ€§ï¼Œæœ€å¤šé‡è¯•5æ¬¡
- ç¯å¢ƒå˜é‡ï¼šé€šè¿‡`${DB_PASSWORD}`ä»ç¯å¢ƒå˜é‡æ³¨å…¥æ•°æ®åº“å¯†ç 

**Redis æœåŠ¡**:
- ä½¿ç”¨è½»é‡çº§`redis:alpine`é•œåƒ
- ç«¯å£æ˜ å°„ï¼šä¸»æœº6379 â†’ å®¹å™¨6379
- ç”¨äºç¼“å­˜ä¼šè¯æ•°æ®å’Œä¸´æ—¶å­˜å‚¨

**Go åç«¯æœåŠ¡**:
- æ„å»ºé…ç½®ï¼šåŸºäºå½“å‰ç›®å½•ä¸Šä¸‹æ–‡ï¼Œä½¿ç”¨Dockerfile.backend
- ç¯å¢ƒå˜é‡ï¼šæ³¨å…¥æ•°æ®åº“è¿æ¥URLå’Œä¸»å¯†é’¥
- ç«¯å£æ˜ å°„ï¼šä¸»æœº8080 â†’ å®¹å™¨8080
- å¯åŠ¨ä¾èµ–ï¼šä¾èµ–PostgreSQLæœåŠ¡å¥åº·æ£€æŸ¥é€šè¿‡åæ‰å¯åŠ¨

**Nginx å‰ç«¯æœåŠ¡**:
- æ„å»ºé…ç½®ï¼šåŸºäºfrontendç›®å½•ä¸Šä¸‹æ–‡ï¼Œä½¿ç”¨Dockerfile
- ç«¯å£æ˜ å°„ï¼šä¸»æœº80 â†’ å®¹å™¨80
- å¯åŠ¨ä¾èµ–ï¼šä¾èµ–åç«¯æœåŠ¡å¯åŠ¨åæ‰å¯åŠ¨

```yaml
# docker-compose.yml
version: '3.8'

services:
  postgres:
    image: pgvector/pgvector:pg16
    environment:
      POSTGRES_USER: council
      POSTGRES_PASSWORD: ${DB_PASSWORD}
      POSTGRES_DB: council
    volumes:
      - pgdata:/var/lib/postgresql/data
    ports:
      - "5432:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U council"]
      interval: 5s
      timeout: 5s
      retries: 5

  backend:
    build:
      context: .
      dockerfile: Dockerfile.backend
    environment:
      DATABASE_URL: postgres://council:${DB_PASSWORD}@postgres:5432/council?sslmode=disable
      COUNCIL_MASTER_KEY: ${COUNCIL_MASTER_KEY}
    ports:
      - "8080:8080"
    depends_on:
      postgres:
        condition: service_healthy

  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    ports:
      - "80:80"
    depends_on:
      - backend

volumes:
  pgdata:
```

**Diagram sources**
- [docker-compose.yml](file://docker-compose.yml#L1-L24)
- [docs/tdd/09_deployment.md](file://docs/tdd/09_deployment.md#L28-L72)

**Section sources**
- [docker-compose.yml](file://docker-compose.yml#L1-L24)
- [docs/tdd/09_deployment.md](file://docs/tdd/09_deployment.md#L25-L74)

## Dockerfile æ„å»ºè¿‡ç¨‹
ç³»ç»Ÿé‡‡ç”¨å¤šé˜¶æ®µæ„å»ºç­–ç•¥ï¼Œåˆ†åˆ«é’ˆå¯¹åç«¯Goåº”ç”¨å’Œå‰ç«¯Reactåº”ç”¨åˆ›å»ºè½»é‡åŒ–çš„ç”Ÿäº§é•œåƒã€‚

### åç«¯å¤šé˜¶æ®µæ„å»º
åç«¯Dockerfileé‡‡ç”¨ä¸¤é˜¶æ®µæ„å»ºï¼Œç¡®ä¿ç”Ÿæˆçš„é•œåƒæœ€å°åŒ–ä¸”å®‰å…¨ã€‚

**æ„å»ºé˜¶æ®µ (builder)**:
- åŸºç¡€é•œåƒï¼š`golang:1.22-alpine`
- å·¥ä½œç›®å½•ï¼š`/app`
- å¤åˆ¶ä¾èµ–æ–‡ä»¶å¹¶ä¸‹è½½æ¨¡å—
- å¤åˆ¶æºä»£ç å¹¶æ‰§è¡Œé™æ€ç¼–è¯‘ï¼Œç¦ç”¨CGOä»¥ç”Ÿæˆé™æ€äºŒè¿›åˆ¶æ–‡ä»¶
- ç¼–è¯‘å‘½ä»¤ï¼š`CGO_ENABLED=0 go build -o council-server ./cmd/council`

**è¿è¡Œé˜¶æ®µ (runtime)**:
- åŸºç¡€é•œåƒï¼š`alpine:3.19`ï¼Œæå°çš„åŸºç¡€é•œåƒ
- å®‰è£…å¿…è¦çš„CAè¯ä¹¦
- ä»æ„å»ºé˜¶æ®µå¤åˆ¶ç¼–è¯‘å¥½çš„äºŒè¿›åˆ¶æ–‡ä»¶åˆ°`/usr/local/bin/`
- æš´éœ²8080ç«¯å£å¹¶è®¾ç½®å¯åŠ¨å‘½ä»¤

```dockerfile
# Dockerfile.backend
FROM golang:1.22-alpine AS builder
WORKDIR /app
COPY go.mod go.sum ./
RUN go mod download
COPY . .
RUN CGO_ENABLED=0 go build -o council-server ./cmd/council

FROM alpine:3.19
RUN apk add --no-cache ca-certificates
COPY --from=builder /app/council-server /usr/local/bin/
EXPOSE 8080
CMD ["council-server"]
```

### å‰ç«¯å¤šé˜¶æ®µæ„å»º
å‰ç«¯DockerfileåŒæ ·é‡‡ç”¨å¤šé˜¶æ®µæ„å»ºï¼Œä¼˜åŒ–å‰ç«¯èµ„æºçš„æ‰“åŒ…å’Œéƒ¨ç½²ã€‚

**æ„å»ºé˜¶æ®µ (builder)**:
- åŸºç¡€é•œåƒï¼š`node:20-alpine`
- å·¥ä½œç›®å½•ï¼š`/app`
- å¤åˆ¶package.jsonå¹¶å®‰è£…ä¾èµ–
- å¤åˆ¶æºä»£ç å¹¶æ‰§è¡Œæ„å»ºå‘½ä»¤`npm run build`
- ç”Ÿæˆç”Ÿäº§çº§åˆ«çš„é™æ€èµ„æºåˆ°distç›®å½•

**è¿è¡Œé˜¶æ®µ (runtime)**:
- åŸºç¡€é•œåƒï¼š`nginx:alpine`ï¼Œè½»é‡çº§WebæœåŠ¡å™¨
- ä»æ„å»ºé˜¶æ®µå¤åˆ¶distç›®å½•åˆ°Nginxé»˜è®¤HTMLç›®å½•
- å¤åˆ¶è‡ªå®šä¹‰Nginxé…ç½®æ–‡ä»¶
- æš´éœ²80ç«¯å£

```dockerfile
# frontend/Dockerfile
FROM node:20-alpine AS builder
WORKDIR /app
COPY package*.json ./
RUN npm ci
COPY . .
RUN npm run build

FROM nginx:alpine
COPY --from=builder /app/dist /usr/share/nginx/html
COPY nginx.conf /etc/nginx/conf.d/default.conf
EXPOSE 80
```

**Diagram sources**
- [Dockerfile.backend](file://Dockerfile.backend)
- [frontend/Dockerfile](file://frontend/Dockerfile)
- [docs/tdd/09_deployment.md](file://docs/tdd/09_deployment.md#L78-L109)

**Section sources**
- [Dockerfile.backend](file://Dockerfile.backend)
- [frontend/Dockerfile](file://frontend/Dockerfile)
- [docs/tdd/09_deployment.md](file://docs/tdd/09_deployment.md#L74-L109)

## ç¯å¢ƒå˜é‡ä¸æ•æ„Ÿä¿¡æ¯ç®¡ç†
ç³»ç»Ÿé€šè¿‡ç¯å¢ƒå˜é‡å®ç°é…ç½®çš„å¤–éƒ¨åŒ–å’Œæ•æ„Ÿä¿¡æ¯çš„å®‰å…¨ç®¡ç†ã€‚

### ç¯å¢ƒå˜é‡é…ç½®
`.env.example`æ–‡ä»¶æä¾›äº†æ‰€æœ‰å¿…è¦ç¯å¢ƒå˜é‡çš„æ¨¡æ¿ï¼š

```env
# æ•°æ®åº“
DATABASE_URL=postgres://council:council_password@localhost:5432/council_db?sslmode=disable

# LLM é…ç½®
LLM_PROVIDER=gemini
LLM_MODEL=gemini-2.0-flash
# LLM_API_KEY=your-api-key-here  # æˆ–é€šè¿‡: export GEMINI_API_KEY=xxx è®¾ç½®

# Redis (å¯é€‰)
REDIS_URL=localhost:6379

# æœåŠ¡å™¨
GIN_MODE=debug
PORT=8080
```

### æ•æ„Ÿä¿¡æ¯å®‰å…¨
ç³»ç»Ÿé‡‡ç”¨å¤šå±‚æ¬¡çš„å®‰å…¨æªæ–½ä¿æŠ¤æ•æ„Ÿä¿¡æ¯ï¼š

**ä¸»å¯†é’¥åŠ å¯†**:
- ä½¿ç”¨ç¯å¢ƒå˜é‡`COUNCIL_MASTER_KEY`ä½œä¸ºä¸»åŠ å¯†å¯†é’¥
- é‡‡ç”¨AES-256-GCMç®—æ³•å¯¹APIå¯†é’¥è¿›è¡ŒåŠ å¯†å­˜å‚¨
- ä¸»å¯†é’¥ä»…åœ¨è¿è¡Œæ—¶æ³¨å…¥ï¼Œä¸å­˜å‚¨åœ¨ä»£ç åº“ä¸­

```go
// ä½¿ç”¨ç¯å¢ƒå˜é‡ä¸­çš„ä¸»å¯†é’¥åŠ å¯† API Key
func EncryptAPIKey(plainKey string) (string, error) {
    masterKey := os.Getenv("COUNCIL_MASTER_KEY") // 32 bytes for AES-256
    block, err := aes.NewCipher([]byte(masterKey))
    if err != nil {
        return "", err
    }
    
    gcm, _ := cipher.NewGCM(block)
    nonce := make([]byte, gcm.NonceSize())
    ciphertext := gcm.Seal(nonce, nonce, []byte(plainKey), nil)
    return base64.StdEncoding.EncodeToString(ciphertext), nil
}
```

**é…ç½®åŠ è½½æœºåˆ¶**:
- `config.Load()`å‡½æ•°ä»ç¯å¢ƒå˜é‡åŠ è½½é…ç½®
- æä¾›åˆç†çš„é»˜è®¤å€¼ï¼Œç¡®ä¿ç³»ç»Ÿå¯è¿è¡Œ
- æ”¯æŒå¤šç§LLMæä¾›å•†çš„APIå¯†é’¥ç®¡ç†

```go
func Load() *Config {
    port := strings.TrimSpace(os.Getenv("PORT"))
    if port == "" {
        port = "8080"
    }

    dbURL := strings.TrimSpace(os.Getenv("DATABASE_URL"))
    if dbURL == "" {
        dbURL = "postgres://user:password@localhost:5432/council?sslmode=disable"
    }

    // ... å…¶ä»–é…ç½®åŠ è½½é€»è¾‘
}
```

**Section sources**
- [.env.example](file://.env.example#L1-L21)
- [internal/pkg/config/config.go](file://internal/pkg/config/config.go#L8-L133)
- [docs/tdd/07_nfr.md](file://docs/tdd/07_nfr.md#L19-L39)

## å®¹å™¨ç”Ÿå‘½å‘¨æœŸç®¡ç†
é€šè¿‡Makefileæä¾›äº†ä¸€å¥—å®Œæ•´çš„å®¹å™¨ç®¡ç†å‘½ä»¤ï¼Œç®€åŒ–äº†å¼€å‘å’Œéƒ¨ç½²æµç¨‹ã€‚

### æ ¸å¿ƒç®¡ç†å‘½ä»¤
**å¯åŠ¨æœåŠ¡**:
```bash
# å¯åŠ¨æ‰€æœ‰æœåŠ¡
make start-all

# æˆ–ä½¿ç”¨Docker Composeç›´æ¥å¯åŠ¨
docker-compose up -d
```

**åœæ­¢æœåŠ¡**:
```bash
# åœæ­¢æ‰€æœ‰æœåŠ¡
make stop-all

# æˆ–ä½¿ç”¨Docker Composeåœæ­¢
docker-compose down
```

**æŸ¥çœ‹çŠ¶æ€**:
```bash
# æŸ¥çœ‹æœåŠ¡çŠ¶æ€
make status

# æŸ¥çœ‹å®¹å™¨åˆ—è¡¨
docker-compose ps
```

**æŸ¥çœ‹æ—¥å¿—**:
```bash
# æŸ¥çœ‹æ‰€æœ‰æœåŠ¡æ—¥å¿—
docker-compose logs -f

# æŸ¥çœ‹ç‰¹å®šæœåŠ¡æ—¥å¿—
docker-compose logs -f backend
```

### Makefile é›†æˆ
Makefileæä¾›äº†äººæ€§åŒ–çš„å‘½ä»¤åˆ«åå’ŒçŠ¶æ€æ˜¾ç¤ºï¼š

```makefile
start-db: ## ğŸ³ Start database services (Postgres + Redis)
	@echo "$(CYAN)ğŸ³ Starting Docker services...$(RESET)"
	@docker compose up -d
	@echo "$(GREEN)âœ… Docker services started$(RESET)"
	@docker compose ps

stop-db: ## ğŸ›‘ Stop database services
	@echo "$(YELLOW)ğŸ›‘ Stopping Docker services...$(RESET)"
	@docker compose down
	@echo "$(GREEN)âœ… Docker services stopped$(RESET)"

start-all: ## ğŸš€ Start all services
	@echo "$(GREEN)$(BOLD)ğŸš€ Starting The Council...$(RESET)"
	@make start-db
	@make start-backend
	@make start-frontend
	@echo "$(GREEN)$(BOLD)âœ… All services started!$(RESET)"
```

**Section sources**
- [Makefile](file://Makefile#L71-L177)
- [docs/tdd/09_deployment.md](file://docs/tdd/09_deployment.md#L169-L177)

## ç”Ÿäº§éƒ¨ç½²æµç¨‹
å®Œæ•´çš„ç”Ÿäº§éƒ¨ç½²æµç¨‹åŒ…æ‹¬ç¯å¢ƒå‡†å¤‡ã€æœåŠ¡å¯åŠ¨ã€æ•°æ®åº“è¿ç§»å’Œå¥åº·æ£€æŸ¥ã€‚

### éƒ¨ç½²æ­¥éª¤
1. **ç¯å¢ƒå‡†å¤‡**:
   ```bash
   # å¤åˆ¶ç¯å¢ƒå˜é‡æ¨¡æ¿
   cp .env.example .env
   
   # ç¼–è¾‘ .env æ–‡ä»¶ï¼Œè®¾ç½® DB_PASSWORD å’Œ COUNCIL_MASTER_KEY
   vim .env
   ```

2. **æ„å»ºå¹¶å¯åŠ¨æœåŠ¡**:
   ```bash
   # ä¸€é”®å¯åŠ¨æ‰€æœ‰æœåŠ¡
   docker-compose up -d
   
   # æˆ–ä½¿ç”¨Makefile
   make start-all
   ```

3. **æ•°æ®åº“è¿ç§»**:
   ```bash
   # æ‰§è¡Œæ•°æ®åº“è¿ç§»
   docker-compose exec backend council-server migrate up
   ```

4. **éªŒè¯éƒ¨ç½²**:
   ```bash
   # æ£€æŸ¥æœåŠ¡çŠ¶æ€
   docker-compose ps
   
   # æŸ¥çœ‹åç«¯æ—¥å¿—
   docker-compose logs -f backend
   
   # è®¿é—®å‰ç«¯: http://localhost
   # è®¿é—®API: http://localhost:8080/api/v1
   ```

5. **åœæ­¢æœåŠ¡**:
   ```bash
   # åœæ­¢æ‰€æœ‰æœåŠ¡
   docker-compose down
   
   # æˆ–ä½¿ç”¨Makefile
   make stop-all
   ```

6. **é‡ç½®æ•°æ®åº“** (è°¨æ…ä½¿ç”¨):
   ```bash
   # åœæ­¢æœåŠ¡å¹¶åˆ é™¤æ•°æ®å·
   docker-compose down -v
   
   # é‡æ–°å¯åŠ¨æœåŠ¡
   docker-compose up -d
   ```

### æœ€ä½³å®è·µ
- **å®‰å…¨é…ç½®**: å§‹ç»ˆä½¿ç”¨å¼ºå¯†ç ä½œä¸º`DB_PASSWORD`å’Œ`COUNCIL_MASTER_KEY`
- **å¤‡ä»½ç­–ç•¥**: å®šæœŸå¤‡ä»½`postgres_data`å·ä¸­çš„æ•°æ®
- **ç›‘æ§å‘Šè­¦**: è®¾ç½®å®¹å™¨å¥åº·æ£€æŸ¥å’Œèµ„æºç›‘æ§
- **ç‰ˆæœ¬æ§åˆ¶**: å°†docker-compose.ymlå’ŒDockerfileçº³å…¥ç‰ˆæœ¬æ§åˆ¶
- **CI/CDé›†æˆ**: å¯å‚è€ƒæ–‡æ¡£ä¸­çš„GitHub Actionsé…ç½®å®ç°è‡ªåŠ¨åŒ–éƒ¨ç½²

**Section sources**
- [docs/tdd/09_deployment.md](file://docs/tdd/09_deployment.md#L168-L177)
- [Makefile](file://Makefile#L46-L177)
- [docker-compose.yml](file://docker-compose.yml#L1-L24)
# 安全凭证管理

<cite>
**本文档引用的文件**  
- [docs/tdd/09_deployment.md](file://docs/tdd/09_deployment.md)
- [Makefile](file://Makefile)
- [.env.example](file://.env.example)
- [internal/pkg/config/config.go](file://internal/pkg/config/config.go)
- [docker-compose.yml](file://docker-compose.yml)
</cite>

## 目录
1. [简介](#简介)
2. [项目结构](#项目结构)
3. [核心组件](#核心组件)
4. [架构概述](#架构概述)
5. [详细组件分析](#详细组件分析)
6. [依赖分析](#依赖分析)
7. [性能考虑](#性能考虑)
8. [故障排除指南](#故障排除指南)
9. [结论](#结论)
10. [附录](#附录)（如有必要）

## 简介
本文档系统阐述了在CI/CD流程中安全凭证管理的最佳实践，重点说明如何通过GitHub Secrets安全存储和使用敏感信息，避免硬编码。结合项目实际配置，展示了安全策略的应用，包括最小权限原则、凭证轮换、访问审计以及常见安全漏洞的防范措施。

## 项目结构
本项目采用分层架构，前端位于`frontend/`目录，后端Go服务位于`cmd/council/`和`internal/`目录，配置文件和文档分别存放在根目录和`docs/`目录中。CI/CD相关配置主要集中在`.github/workflows/`目录下，而本地开发和部署配置则通过`Makefile`和`docker-compose.yml`进行管理。

```mermaid
graph TD
subgraph "根目录"
A[Makefile]
B[docker-compose.yml]
C[.env.example]
end
subgraph "后端"
D[cmd/council/main.go]
E[internal/pkg/config/config.go]
end
subgraph "前端"
F[frontend/src]
end
subgraph "文档"
G[docs/tdd/09_deployment.md]
end
A --> D
B --> D
C --> D
G --> A
G --> B
```

**图示来源**
- [Makefile](file://Makefile)
- [docker-compose.yml](file://docker-compose.yml)
- [docs/tdd/09_deployment.md](file://docs/tdd/09_deployment.md)

**本节来源**
- [Makefile](file://Makefile)
- [docker-compose.yml](file://docker-compose.yml)
- [.env.example](file://.env.example)

## 核心组件
项目的核心安全凭证管理机制围绕环境变量和GitHub Actions Secrets构建。敏感信息如数据库密码、API密钥等均通过环境变量注入，绝不硬编码在源代码中。`internal/pkg/config/config.go`文件负责从环境变量中加载配置，确保运行时的安全性。

**本节来源**
- [internal/pkg/config/config.go](file://internal/pkg/config/config.go)
- [.env.example](file://.env.example)

## 架构概述
系统的部署架构分为开发环境和生产环境。开发环境使用本地服务，而生产环境通过Docker容器化部署，利用`docker-compose.yml`编排PostgreSQL、Redis和Go后端服务。CI/CD流程通过GitHub Actions自动化构建和推送Docker镜像，整个过程依赖GitHub Secrets进行安全的身份验证。

```mermaid
graph TD
subgraph Dev["开发"]
Vite["Vite 开发 :5173"]
Go["Go 后端 :8080"]
PG_Dev["PostgreSQL :5432"]
end
subgraph Prod["生产 - Docker"]
Nginx["Nginx :80"]
API["Go API 容器"]
PG_Prod[("PostgreSQL + pgvector")]
end
Vite --> Go
Go --> PG_Dev
Nginx --> API
API --> PG_Prod
```

**图示来源**
- [docs/tdd/09_deployment.md](file://docs/tdd/09_deployment.md#L5-L23)

## 详细组件分析

### CI/CD 凭证管理分析
CI/CD流程的安全性是通过GitHub Secrets实现的。在`docs/tdd/09_deployment.md`中定义的GitHub Actions工作流（`release.yml`）使用`docker/login-action@v3`步骤，通过`secrets.DOCKER_USERNAME`和`secrets.DOCKER_TOKEN`登录Docker Hub。这种方式确保了凭证在运行时由GitHub安全地注入，而不会暴露在日志或代码中。

#### 对于API/服务组件：
```mermaid
sequenceDiagram
participant GitHub as "GitHub Actions"
participant DockerHub as "Docker Hub"
participant BuildStep as "构建步骤"
GitHub->>DockerHub : 使用 secrets.DOCKER_USERNAME 和 secrets.DOCKER_TOKEN 登录
DockerHub-->>GitHub : 认证成功
GitHub->>BuildStep : 执行构建和推送镜像
BuildStep->>DockerHub : 推送 council-api 和 council-web 镜像
DockerHub-->>GitHub : 推送成功
```

**图示来源**
- [docs/tdd/09_deployment.md](file://docs/tdd/09_deployment.md#L127-L151)

### 环境变量配置分析
项目通过`.env.example`文件提供环境变量模板，开发者需复制并重命名为`.env`来配置本地环境。`Makefile`中的`install`目标会自动创建`.env`文件（如果不存在），并从`.env.example`复制内容。`config.go`中的`Load()`函数负责读取这些环境变量，实现了配置与代码的分离。

**本节来源**
- [.env.example](file://.env.example)
- [Makefile](file://Makefile#L312)
- [internal/pkg/config/config.go](file://internal/pkg/config/config.go)

## 依赖分析
项目依赖通过`go.mod`和`package.json`管理。`Makefile`集成了`go mod download`和`npm install`命令，确保依赖的一致性。安全扫描通过`govulncheck`和`npm audit`在`Makefile`的`security-scan`目标中执行，主动识别依赖中的已知漏洞。

```mermaid
graph LR
A[Makefile] --> B[go mod download]
A --> C[npm install]
A --> D[govulncheck]
A --> E[npm audit]
B --> F[Go 依赖]
C --> G[Node.js 依赖]
D --> H[Go 漏洞扫描]
E --> I[Node.js 漏洞扫描]
```

**图示来源**
- [Makefile](file://Makefile)
- [docs/specs/sprint5/SPEC-504-security-hardening.md](file://docs/specs/sprint5/SPEC-504-security-hardening.md#L283-L287)

**本节来源**
- [Makefile](file://Makefile)
- [go.mod](file://go.mod)
- [frontend/package.json](file://frontend/package.json)

## 性能考虑
虽然凭证管理本身对性能影响较小，但其设计间接影响了系统的可维护性和部署效率。使用环境变量和容器化部署使得应用配置灵活，便于在不同环境中快速部署和扩展。Docker镜像的分层构建（如`Dockerfile.backend`中的多阶段构建）也优化了构建时间和镜像大小。

## 故障排除指南
当遇到与凭证相关的部署失败时，应首先检查GitHub Actions工作流的执行日志。如果登录Docker Hub失败，确认`DOCKER_USERNAME`和`DOCKER_TOKEN`这两个Secrets已在GitHub仓库的Settings > Secrets and variables > Actions中正确配置。对于本地开发，确保`.env`文件存在且包含所有必需的变量。

**本节来源**
- [docs/tdd/09_deployment.md](file://docs/tdd/09_deployment.md)
- [.env.example](file://.env.example)

## 结论
该项目通过结合GitHub Secrets、环境变量和自动化脚本（Makefile），建立了一套健壮的安全凭证管理体系。它严格遵循了最小权限和避免硬编码的原则，有效保护了Docker Hub等关键服务的访问凭证。建议定期轮换`DOCKER_TOKEN`等长期凭证，并利用GitHub Actions的审计日志功能监控凭证的使用情况，以持续保障CI/CD流程的安全性。

## 附录
### .env 文件示例
```env
# 数据库
DATABASE_URL=postgres://council:council_password@localhost:5432/council_db?sslmode=disable

# LLM 配置
LLM_PROVIDER=gemini
LLM_MODEL=gemini-2.0-flash

# Redis (可选)
REDIS_URL=localhost:6379

# 服务器
GIN_MODE=debug
PORT=8080
```

**本节来源**
- [.env.example](file://.env.example)
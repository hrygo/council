# 容器化部署

<cite>
**本文档引用的文件**
- [docker-compose.yml](file://docker-compose.yml)
- [docs/tdd/09_deployment.md](file://docs/tdd/09_deployment.md)
- [.env.example](file://.env.example)
- [cmd/council/main.go](file://cmd/council/main.go)
- [internal/pkg/config/config.go](file://internal/pkg/config/config.go)
- [internal/infrastructure/db/postgres.go](file://internal/infrastructure/db/postgres.go)
- [frontend/package.json](file://frontend/package.json)
</cite>

## 目录
1. [简介](#简介)
2. [项目结构](#项目结构)
3. [核心组件](#核心组件)
4. [架构概述](#架构概述)
5. [详细组件分析](#详细组件分析)
6. [依赖分析](#依赖分析)
7. [性能考虑](#性能考虑)
8. [故障排除指南](#故障排除指南)
9. [结论](#结论)
10. [附录](#附录)（如有必要）

## 简介
本文档深入解析The Council项目的容器化部署架构，重点分析Docker部署配置。文档详细说明了`docker-compose.yml`中PostgreSQL和Redis服务的配置细节，包括端口映射、数据卷挂载和环境变量设置。同时，文档解析了后端Dockerfile的多阶段构建策略，从前端Dockerfile的Nginx配置到后端Go应用的优化构建过程。此外，文档还提供了容器网络配置、资源限制和安全加固建议，为The Council应用的生产部署提供全面指导。

## 项目结构
The Council项目采用分层架构设计，包含前端、后端和基础设施组件。项目根目录包含Docker编排文件、环境配置和构建脚本。前端位于`frontend/`目录，使用React框架构建单页应用；后端位于`cmd/council/`和`internal/`目录，使用Go语言实现核心业务逻辑；基础设施配置包括`docker-compose.yml`和环境变量文件。这种结构化的组织方式便于容器化部署和维护。

```mermaid
graph TD
subgraph Root["项目根目录"]
Docker["docker-compose.yml"]
Env[".env.example"]
Makefile["Makefile"]
GoMod["go.mod"]
end
subgraph Frontend["前端 (React)"]
FrontendDir["frontend/"]
PackageJson["package.json"]
Src["src/"]
end
subgraph Backend["后端 (Go)"]
CmdDir["cmd/council/"]
InternalDir["internal/"]
MainGo["main.go"]
end
subgraph Docs["文档"]
TDD["docs/tdd/"]
Specs["docs/specs/"]
end
Docker --> FrontendDir
Docker --> CmdDir
Env --> Docker
Makefile --> Docker
Makefile --> CmdDir
Makefile --> FrontendDir
```

**Diagram sources**
- [docker-compose.yml](file://docker-compose.yml#L1-L24)
- [frontend/package.json](file://frontend/package.json#L1-L60)
- [cmd/council/main.go](file://cmd/council/main.go#L1-L150)

**Section sources**
- [docker-compose.yml](file://docker-compose.yml#L1-L24)
- [frontend/package.json](file://frontend/package.json#L1-L60)
- [cmd/council/main.go](file://cmd/council/main.go#L1-L150)

## 核心组件
The Council的核心组件包括基于Go的后端服务、React前端应用、PostgreSQL数据库（含pgvector扩展）和Redis缓存服务。后端服务通过Gin框架提供REST API和WebSocket接口，前端应用使用React Flow实现可视化工作流编辑器。PostgreSQL用于持久化存储工作流、代理和会话数据，Redis用于缓存和会话管理。这些组件通过Docker Compose进行编排，形成完整的多智能体协作系统。

**Section sources**
- [cmd/council/main.go](file://cmd/council/main.go#L1-L150)
- [internal/pkg/config/config.go](file://internal/pkg/config/config.go#L1-L133)
- [internal/infrastructure/db/postgres.go](file://internal/infrastructure/db/postgres.go#L1-L66)

## 架构概述
The Council采用微服务架构，通过Docker容器化部署。前端React应用通过Nginx提供静态文件服务，后端Go服务处理业务逻辑，PostgreSQL存储结构化数据并支持向量搜索，Redis提供高速缓存。各服务通过Docker网络进行通信，前端通过REST API和WebSocket与后端交互，后端通过数据库连接池访问PostgreSQL，通过Redis客户端操作缓存。

```mermaid
graph TD
subgraph "前端"
Nginx["Nginx Web服务器"]
React["React SPA"]
end
subgraph "后端"
Go["Go API服务"]
Gin["Gin框架"]
end
subgraph "基础设施"
Postgres["PostgreSQL<br/>pgvector:pg16"]
Redis["Redis缓存"]
end
React --> Nginx
Nginx --> Go
Go --> Postgres
Go --> Redis
User[用户] --> Nginx
```

**Diagram sources**
- [docker-compose.yml](file://docker-compose.yml#L1-L24)
- [docs/tdd/09_deployment.md](file://docs/tdd/09_deployment.md#L25-L72)
- [cmd/council/main.go](file://cmd/council/main.go#L1-L150)

## 详细组件分析

### 数据库服务分析
The Council使用PostgreSQL作为主数据库，特别配置了pgvector扩展以支持向量相似性搜索。在`docker-compose.yml`中，PostgreSQL服务使用`pgvector/pgvector:pg16`镜像，通过端口映射将容器的5432端口暴露给主机。数据卷`postgres_data`挂载到`/var/lib/postgresql/data`，确保数据持久化。环境变量配置了数据库用户、密码和数据库名称，确保服务启动时自动创建相应的数据库实例。

```mermaid
graph TD
PostgresService["PostgreSQL服务"]
Image["镜像: pgvector/pgvector:pg16"]
PortMapping["端口映射: 5432:5432"]
VolumeMount["数据卷: postgres_data"]
Environment["环境变量"]
PostgresService --> Image
PostgresService --> PortMapping
PostgresService --> VolumeMount
PostgresService --> Environment
Environment --> User["POSTGRES_USER=council"]
Environment --> Password["POSTGRES_PASSWORD=council_password"]
Environment --> Database["POSTGRES_DB=council_db"]
```

**Diagram sources**
- [docker-compose.yml](file://docker-compose.yml#L2-L13)
- [docs/tdd/09_deployment.md](file://docs/tdd/09_deployment.md#L32-L47)

**Section sources**
- [docker-compose.yml](file://docker-compose.yml#L2-L13)
- [docs/tdd/09_deployment.md](file://docs/tdd/09_deployment.md#L32-L47)

### 缓存服务分析
Redis服务在The Council架构中扮演缓存和会话管理的角色。在`docker-compose.yml`中，Redis服务使用`redis:alpine`轻量级镜像，通过端口映射将容器的6379端口暴露给主机。服务配置了`restart: always`策略，确保容器在失败时自动重启。Redis主要用于存储临时会话数据、缓存频繁访问的数据以及作为WebSocket通信的中间件，提高系统整体性能和响应速度。

```mermaid
graph TD
RedisService["Redis服务"]
Image["镜像: redis:alpine"]
PortMapping["端口映射: 6379:6379"]
RestartPolicy["重启策略: always"]
RedisService --> Image
RedisService --> PortMapping
RedisService --> RestartPolicy
```

**Diagram sources**
- [docker-compose.yml](file://docker-compose.yml#L15-L20)
- [.env.example](file://.env.example#L15-L16)

**Section sources**
- [docker-compose.yml](file://docker-compose.yml#L15-L20)
- [.env.example](file://.env.example#L15-L16)

### 后端多阶段构建分析
后端Dockerfile采用多阶段构建策略，优化生产镜像的大小和安全性。第一阶段使用`golang:1.22-alpine`作为构建器，安装依赖并编译Go应用。第二阶段使用`alpine:3.19`作为运行时基础镜像，仅复制编译后的二进制文件，不包含Go编译器和源代码。这种策略显著减小了最终镜像的大小，提高了安全性，同时确保了构建环境的纯净和可重复性。

```mermaid
flowchart TD
Start([开始]) --> BuildStage["构建阶段"]
BuildStage --> GoImage["FROM golang:1.22-alpine AS builder"]
GoImage --> CopyFiles["COPY go.mod go.sum ./"]
CopyFiles --> DownloadDeps["RUN go mod download"]
DownloadDeps --> CopySrc["COPY . ."]
CopySrc --> BuildBinary["RUN CGO_ENABLED=0 go build -o council-server ./cmd/council"]
BuildBinary --> RuntimeStage["运行时阶段"]
RuntimeStage --> AlpineImage["FROM alpine:3.19"]
AlpineImage --> InstallCerts["RUN apk add --no-cache ca-certificates"]
InstallCerts --> CopyBinary["COPY --from=builder /app/council-server /usr/local/bin/"]
CopyBinary --> ExposePort["EXPOSE 8080"]
ExposePort --> RunCmd["CMD [\"council-server\"]"]
RunCmd --> End([完成])
```

**Diagram sources**
- [docs/tdd/09_deployment.md](file://docs/tdd/09_deployment.md#L79-L91)

**Section sources**
- [docs/tdd/09_deployment.md](file://docs/tdd/09_deployment.md#L79-L91)

### 前端静态文件服务分析
前端Dockerfile使用Nginx作为Web服务器，为React应用提供静态文件服务。构建过程分为两个阶段：第一阶段使用Node.js镜像构建React应用，安装依赖并执行生产构建；第二阶段使用`nginx:alpine`镜像，将构建生成的静态文件复制到Nginx的默认HTML目录，并复制自定义的Nginx配置。这种配置确保了前端应用的高效交付和静态资源的正确处理。

```mermaid
flowchart TD
Start([开始]) --> BuildStage["构建阶段"]
BuildStage --> NodeImage["FROM node:20-alpine AS builder"]
NodeImage --> SetWorkdir["WORKDIR /app"]
SetWorkdir --> CopyPackage["COPY package*.json ./"]
CopyPackage --> InstallDeps["RUN npm ci"]
InstallDeps --> CopySrc["COPY . ."]
CopySrc --> BuildApp["RUN npm run build"]
BuildApp --> RuntimeStage["运行时阶段"]
RuntimeStage --> NginxImage["FROM nginx:alpine"]
NginxImage --> CopyDist["COPY --from=builder /app/dist /usr/share/nginx/html"]
CopyDist --> CopyConfig["COPY nginx.conf /etc/nginx/conf.d/default.conf"]
CopyConfig --> ExposePort["EXPOSE 80"]
ExposePort --> End([完成])
```

**Diagram sources**
- [docs/tdd/09_deployment.md](file://docs/tdd/09_deployment.md#L97-L108)

**Section sources**
- [docs/tdd/09_deployment.md](file://docs/tdd/09_deployment.md#L97-L108)

## 依赖分析
The Council的组件依赖关系清晰明确。前端应用依赖后端API服务获取数据和执行操作；后端服务依赖PostgreSQL进行数据持久化存储，依赖Redis进行缓存和会话管理。构建时，后端依赖Go模块，前端依赖Node.js包。运行时，所有服务通过Docker网络进行通信，形成松耦合但高效协作的系统架构。

```mermaid
graph TD
Frontend["前端应用"]
Backend["后端服务"]
Postgres["PostgreSQL数据库"]
Redis["Redis缓存"]
Frontend --> Backend : "REST API<br/>WebSocket"
Backend --> Postgres : "SQL查询"
Backend --> Redis : "缓存读写"
BuildTime["构建时依赖"]
BuildTime --> GoModules["Go模块"]
BuildTime --> NpmPackages["NPM包"]
Runtime["运行时依赖"]
Runtime --> DockerNetwork["Docker网络"]
Runtime --> EnvironmentVars["环境变量"]
```

**Diagram sources**
- [docker-compose.yml](file://docker-compose.yml#L1-L24)
- [cmd/council/main.go](file://cmd/council/main.go#L1-L150)
- [internal/pkg/config/config.go](file://internal/pkg/config/config.go#L1-L133)

**Section sources**
- [docker-compose.yml](file://docker-compose.yml#L1-L24)
- [cmd/council/main.go](file://cmd/council/main.go#L1-L150)
- [internal/pkg/config/config.go](file://internal/pkg/config/config.go#L1-L133)

## 性能考虑
The Council的容器化部署在性能方面进行了多项优化。使用Alpine Linux作为基础镜像减小了容器体积，加快了启动速度。多阶段构建确保生产镜像只包含必要文件，减少了攻击面和资源占用。PostgreSQL的pgvector扩展支持高效的向量搜索，Redis缓存减少了数据库查询压力。Nginx作为前端服务器提供了高效的静态文件服务和反向代理功能。建议在生产环境中设置适当的资源限制，监控容器性能，并根据负载情况进行水平扩展。

## 故障排除指南
当遇到容器化部署问题时，可以按照以下步骤进行排查：首先检查Docker服务是否正常运行，使用`docker compose ps`查看各服务状态；其次检查日志输出，使用`docker compose logs`查看各容器的日志；然后验证环境变量配置是否正确，特别是数据库连接字符串和API密钥；最后确保端口没有冲突，网络配置正确。对于数据库问题，可以使用`make reset-db`重置数据库；对于构建问题，检查Dockerfile和依赖配置。

**Section sources**
- [docker-compose.yml](file://docker-compose.yml#L1-L24)
- [Makefile](file://Makefile#L71-L93)
- [.env.example](file://.env.example#L1-L21)

## 结论
The Council的容器化部署架构设计合理，通过Docker Compose实现了服务的编排和管理。PostgreSQL和Redis的配置确保了数据持久化和高性能缓存，多阶段构建策略优化了生产镜像。前端使用Nginx提供高效的静态文件服务，后端Go应用通过轻量级Alpine镜像运行。整体架构支持快速部署、易于扩展和维护，为多智能体协作系统提供了稳定可靠的运行环境。

## 附录
### 环境变量参考
| 环境变量 | 描述 | 默认值 |
| :--- | :--- | :--- |
| `DATABASE_URL` | PostgreSQL数据库连接字符串 | `postgres://council:council_password@localhost:5432/council_db?sslmode=disable` |
| `LLM_PROVIDER` | 默认LLM提供商 | `gemini` |
| `LLM_MODEL` | 默认LLM模型 | `gemini-2.0-flash` |
| `REDIS_URL` | Redis服务器地址 | `localhost:6379` |
| `GIN_MODE` | Gin框架运行模式 | `debug` |
| `PORT` | 后端服务监听端口 | `8080` |

**Section sources**
- [.env.example](file://.env.example#L1-L21)
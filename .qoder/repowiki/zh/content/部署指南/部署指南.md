# 部署指南

<cite>
**本文档中引用的文件**  
- [docker-compose.yml](file://docker-compose.yml)
- [main.go](file://cmd/council/main.go)
- [config.go](file://internal/pkg/config/config.go)
- [.env.example](file://.env.example)
- [postgres.go](file://internal/infrastructure/db/postgres.go)
- [redis.go](file://internal/infrastructure/cache/redis.go)
- [migrator.go](file://internal/infrastructure/db/migrator.go)
- [seeder.go](file://internal/resources/seeder.go)
- [SPEC-504-security-hardening.md](file://docs/specs/sprint5/SPEC-504-security-hardening.md)
</cite>

## 目录
1. [简介](#简介)
2. [项目结构](#项目结构)
3. [核心组件](#核心组件)
4. [架构概述](#架构概述)
5. [详细组件分析](#详细组件分析)
6. [依赖分析](#依赖分析)
7. [性能考量](#性能考量)
8. [故障排除指南](#故障排除指南)
9. [结论](#结论)

## 简介
The Council 是一个基于多智能体协作的AI治理系统，通过辩论机制生成高质量决策。本部署文档旨在指导用户在不同环境中部署该系统，涵盖从本地开发到生产环境的完整流程。

## 项目结构
The Council 项目采用分层架构设计，主要包含以下目录：

- **cmd/council/main.go**: 应用程序入口点
- **internal/**: 核心业务逻辑，包括API处理、工作流引擎、基础设施等
- **frontend/**: 前端React应用
- **docs/**: 详细的技术规格和设计文档
- **scripts/**: 辅助脚本
- **docker-compose.yml**: 本地Docker部署配置
- **Makefile**: 开发和部署自动化工具

```mermaid
graph TD
    subgraph "Frontend"
        Frontend["React前端"]
    end
    subgraph "Backend"
        BackendNode["Go后端"]
        API["REST API"]
        WS["WebSocket"]
    end
    subgraph "Infrastructure"
        DB[(PostgreSQL)]
        Redis[(Redis)]
    end
    Frontend --> BackendNode
    BackendNode --> DB
    BackendNode --> Redis
    BackendNode --> LLMProviders["LLM提供商"]
```

**Diagram sources**
- [docker-compose.yml](file://docker-compose.yml#L1-L24)
- [main.go](file://cmd/council/main.go#L1-L150)

**Section sources**
- [docker-compose.yml](file://docker-compose.yml#L1-L24)
- [main.go](file://cmd/council/main.go#L1-L150)

## 核心组件
The Council 的核心组件包括：

- **工作流引擎**: 处理复杂的多智能体协作流程
- **智能体管理**: 管理不同角色的AI智能体
- **记忆系统**: 基于向量的长期记忆存储
- **数据库**: PostgreSQL用于持久化存储
- **缓存**: Redis用于会话管理和临时数据存储

**Section sources**
- [main.go](file://cmd/council/main.go#L21-L149)
- [config.go](file://internal/pkg/config/config.go#L8-L132)

## 架构概述
The Council 采用微服务架构风格，各组件通过清晰的接口进行通信。

```mermaid
graph TB
Client[客户端] --> API[REST API]
Client --> WS[WebSocket]
API --> Workflow[工作流引擎]
API --> Agent[智能体管理]
API --> Template[模板管理]
API --> Memory[记忆系统]
Workflow --> DB[(PostgreSQL)]
Workflow --> Cache[(Redis)]
Workflow --> LLM[LLM网关]
LLM --> OpenAI[OpenAI]
LLM --> Gemini[Google Gemini]
LLM --> DeepSeek[DeepSeek]
LLM --> DashScope[通义千问]
LLM --> SiliconFlow[硅基流动]
```

**Diagram sources**
- [main.go](file://cmd/council/main.go#L98-L143)
- [config.go](file://internal/pkg/config/config.go#L8-L132)

## 详细组件分析

### 本地Docker部署
The Council 提供了完整的Docker部署方案，简化了本地开发环境的搭建。

#### 网络配置
Docker Compose 默认创建一个名为 `council_default` 的网络，所有服务都在此网络中通信。

#### 卷挂载
- PostgreSQL数据持久化到 `postgres_data` 卷
- 无其他卷挂载需求

#### 环境变量设置
通过 `.env` 文件或环境变量配置系统参数：

```bash
# 数据库
DATABASE_URL=postgres://council:council_password@localhost:5432/council_db?sslmode=disable

# LLM配置
LLM_PROVIDER=gemini
LLM_MODEL=gemini-2.0-flash

# Redis
REDIS_URL=localhost:6379

# 服务器
PORT=8080
```

**Section sources**
- [docker-compose.yml](file://docker-compose.yml#L1-L24)
- [.env.example](file://.env.example#L1-L21)

### 生产环境部署最佳实践

#### Kubernetes编排
建议使用Kubernetes进行生产环境部署，实现高可用性和弹性伸缩。

#### Ingress控制器配置
配置Ingress控制器以处理外部HTTP/HTTPS流量，实现负载均衡和SSL终止。

#### 外部PostgreSQL和Redis实例
生产环境应使用独立的、高可用的PostgreSQL和Redis实例，而非容器化部署。

```mermaid
graph TB
Internet[互联网] --> Ingress[Ingress控制器]
Ingress --> Service[服务]
Service --> Pod[Pod实例]
Pod --> ExternalDB[(外部PostgreSQL)]
Pod --> ExternalRedis[(外部Redis)]
```

**Diagram sources**
- [postgres.go](file://internal/infrastructure/db/postgres.go#L1-L66)
- [redis.go](file://internal/infrastructure/cache/redis.go#L1-L51)

**Section sources**
- [postgres.go](file://internal/infrastructure/db/postgres.go#L1-L66)
- [redis.go](file://internal/infrastructure/cache/redis.go#L1-L51)

## 依赖分析
The Council 的依赖关系清晰，核心组件之间耦合度低。

```mermaid
graph TD
main[main.go] --> config[config.go]
main --> db[postgres.go]
main --> cache[redis.go]
main --> migrator[migrator.go]
main --> seeder[seeder.go]
config --> env[环境变量]
db --> postgres[PostgreSQL]
cache --> redis[Redis]
migrator --> db
seeder --> db
```

**Diagram sources**
- [main.go](file://cmd/council/main.go#L21-L149)
- [config.go](file://internal/pkg/config/config.go#L8-L132)
- [postgres.go](file://internal/infrastructure/db/postgres.go#L1-L66)
- [redis.go](file://internal/infrastructure/cache/redis.go#L1-L51)
- [migrator.go](file://internal/infrastructure/db/migrator.go#L1-L109)
- [seeder.go](file://internal/resources/seeder.go#L1-L420)

**Section sources**
- [go.mod](file://go.mod#L1-L10)
- [go.sum](file://go.sum#L1-L50)

## 性能考量
### 数据库连接池大小
PostgreSQL连接池大小应根据预期并发量进行调整，默认配置适用于中小规模部署。

### LLM客户端超时设置
LLM客户端应设置合理的超时时间，避免因远程服务响应缓慢而影响整体性能。

### 监控
- **日志收集**: 集中收集应用日志
- **指标暴露**: 暴露关键性能指标供监控系统采集

### 备份恢复策略
定期备份PostgreSQL数据库，确保数据安全。

### 安全加固
- **HTTPS**: 强制使用HTTPS加密通信
- **防火墙规则**: 限制不必要的端口访问

### 水平扩展方案
通过增加Pod实例实现水平扩展，配合负载均衡器分发流量。

[无具体文件分析，因此不添加来源]

## 故障排除指南
### 常见问题
- 数据库连接失败
- Redis连接超时
- LLM API密钥无效

### 调试工具
- 使用 `make status` 检查服务状态
- 使用 `make logs-db` 查看数据库日志

**Section sources**
- [Makefile](file://Makefile#L52-L65)
- [SPEC-504-security-hardening.md](file://docs/specs/sprint5/SPEC-504-security-hardening.md#L279-L292)

## 结论
The Council 提供了一套完整的部署方案，从本地开发到生产环境都有相应的最佳实践。通过合理的配置和优化，可以确保系统稳定高效运行。

[无具体文件分析，因此不添加来源]
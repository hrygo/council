# 表单控件实现

<cite>
**本文档中引用的文件**  
- [FactCheckNodeForm.tsx](file://frontend/src/features/editor/components/PropertyPanel/NodeForms/FactCheckNodeForm.tsx)
- [workflow.ts](file://frontend/src/types/workflow.ts)
- [PropertyPanel.tsx](file://frontend/src/features/editor/components/PropertyPanel/PropertyPanel.tsx)
- [tailwind.config.js](file://frontend/tailwind.config.js)
- [fact_check.go](file://internal/core/workflow/nodes/fact_check.go)
- [factory.go](file://internal/core/workflow/nodes/factory.go)
- [fact_check.md](file://docs/tdd/02_core/12_fact_check.md)
- [SPEC-404-factcheck-processor.md](file://docs/specs/backend/SPEC-404-factcheck-processor.md)
</cite>

## 目录
1. [引言](#引言)
2. [搜索源多选框控件](#搜索源多选框控件)
3. [max_queries滑块控件](#max_queries滑块控件)
4. [verify_threshold置信度阈值滑块](#verify_threshold置信度阈值滑块)
5. [UI样式与Tailwind CSS设计](#ui样式与tailwind-css设计)
6. [实际使用示例与常见问题排查](#实际使用示例与常见问题排查)
7. [结论](#结论)

## 引言
事实核查节点配置表单是工作流编辑器中的关键组件，用于定义事实核查过程的行为参数。该表单包含多个交互式控件：搜索源多选框（tavily、serper、local_kb）、max_queries滑块和verify_threshold置信度阈值滑块。这些控件通过React状态管理与后端逻辑紧密集成，确保用户输入能正确传递至工作流执行引擎。本文将深入解析这些控件的实现机制、数据绑定方式及前后端协作流程。

**Section sources**
- [FactCheckNodeForm.tsx](file://frontend/src/features/editor/components/PropertyPanel/NodeForms/FactCheckNodeForm.tsx#L1-L88)
- [workflow.ts](file://frontend/src/types/workflow.ts#L27-L31)

## 搜索源多选框控件

搜索源多选框允许用户选择一个或多个信息来源进行事实核查，包括Tavily（Web）、Serper（Web）和本地知识库（Local Knowledge Base）。其交互逻辑由`handleSourceToggle`函数驱动。

`handleSourceToggle`函数接收一个字符串参数`source`，表示被切换的搜索源。它首先获取当前已选中的搜索源数组`data.search_sources`，若该字段为空则初始化为空数组。接着判断当前源是否已在数组中：如果存在，则使用`filter`方法将其移除；否则使用扩展运算符`[...current, source]`将其添加。最终通过`onChange`回调将更新后的数组写回父组件状态。

每个复选框的`checked`属性绑定到`data.search_sources?.includes('source')`表达式，确保UI状态与数据同步。`onChange`事件直接调用`handleSourceToggle('source')`完成状态切换。这种设计实现了受控组件模式，所有状态变更都通过统一的`onChange`接口处理，便于调试和状态追踪。

**Section sources**
- [FactCheckNodeForm.tsx](file://frontend/src/features/editor/components/PropertyPanel/NodeForms/FactCheckNodeForm.tsx#L11-L17)
- [workflow.ts](file://frontend/src/types/workflow.ts#L28)

## max_queries滑块控件

`max_queries`滑块控件用于设置最大查询次数，范围为1到10，步长为1。该控件实现了完整的双向数据绑定机制。

滑块的`value`属性绑定到`data.max_queries || 3`，提供默认值3以避免undefined情况。`min`、`max`和`step`属性分别设为1、10和1，限制用户输入的有效范围。当用户拖动滑块时，`onChange`事件处理器被触发，接收事件对象`e`，从中提取`e.target.value`字符串值，并使用`parseInt`转换为整数类型，防止意外传入浮点数或字符串。

转换后的数值通过`onChange({ max_queries: parseInt(e.target.value) })`提交给父组件，形成闭环的数据流。此设计确保了前端显示值与内部状态的一致性，同时通过类型转换保障了后端处理的可靠性。该值最终在`FactCheckProcessor`中用于控制搜索请求的数量。

**Section sources**
- [FactCheckNodeForm.tsx](file://frontend/src/features/editor/components/PropertyPanel/NodeForms/FactCheckNodeForm.tsx#L59-L66)
- [SPEC-404-factcheck-processor.md](file://docs/specs/backend/SPEC-404-factcheck-processor.md#L11)

## verify_threshold置信度阈值滑块

`verify_threshold`滑块控件用于设定事实核查通过所需的最低置信度，前端显示为50%-100%的百分比形式，但内部存储为0.5-1.0的浮点数。

滑块的`min`、`max`和`step`属性分别设为50、100和5，对应50%到100%的整数百分比。`value`属性绑定为`(data.verify_threshold || 0.7) * 100`，将内部浮点值映射为前端可操作的整数。界面上的显示值使用`Math.round((data.verify_threshold || 0.7) * 100) + '%'`格式化输出，提升可读性。

当用户调整滑块时，`onChange`回调接收整数百分比值，执行`parseInt(e.target.value) / 100`将其还原为0.5-1.0范围内的浮点数，并通过`onChange({ verify_threshold: ... })`更新状态。该阈值最终传递给`FactCheckProcessor`，用于判断核查结果是否通过。例如，在`factory.go`中，`verify_threshold`从`node.Properties`提取并赋值给处理器实例。

**Section sources**
- [FactCheckNodeForm.tsx](file://frontend/src/features/editor/components/PropertyPanel/NodeForms/FactCheckNodeForm.tsx#L70-L83)
- [factory.go](file://internal/core/workflow/nodes/factory.go#L79-L87)

## UI样式与Tailwind CSS设计

表单UI采用Tailwind CSS进行样式设计，支持明暗两种模式。主题色使用`teal-600`作为复选框的选中颜色，通过`text-teal-600 focus:ring-teal-500`类名实现。滑块控件使用`accent-teal-500`统一高亮色，确保视觉一致性。

暗色模式通过`dark:`前缀类支持，如`dark:bg-gray-700`、`dark:text-gray-300`等，在`tailwind.config.js`中配置`darkMode: 'class'`，允许通过CSS类切换主题。背景使用`bg-gray-200`（明）和`dark:bg-gray-700`（暗），文字使用`text-gray-700`（明）和`dark:text-gray-300`（暗），保证在不同环境下均有良好可读性。

控件布局采用`space-y-4`、`space-y-2`等间距类，配合`flex`和`grid`实现清晰的层次结构。字体使用`text-sm`、`text-xs`区分层级，`font-semibold`和`uppercase`增强标签可识别性。整体设计简洁专业，符合现代Web应用审美。

**Section sources**
- [FactCheckNodeForm.tsx](file://frontend/src/features/editor/components/PropertyPanel/NodeForms/FactCheckNodeForm.tsx#L29-L83)
- [tailwind.config.js](file://frontend/tailwind.config.js#L3)

## 实际使用示例与常见问题排查

### 使用示例
用户可在事实核查节点中选择“Tavily”和“local_kb”作为搜索源，设置`max_queries=5`以增加信息覆盖，将`verify_threshold`调至80%以提高验证严格度。配置完成后，工作流引擎将使用这些参数执行核查任务。

### 常见问题排查
- **状态未更新**：检查`onChange`回调是否正确传递，确保`Partial<FactCheckNodeData>`类型匹配。
- **数值转换错误**：确认`parseInt`调用位置正确，避免在滑块值绑定时遗漏转换。
- **默认值缺失**：确保`data.max_queries || 3`和`data.verify_threshold || 0.7`等默认值逻辑存在，防止undefined导致渲染异常。
- **暗色模式失效**：验证`darkMode: 'class'`是否在Tailwind配置中启用，并检查HTML根元素是否正确添加`class="dark"`。

**Section sources**
- [FactCheckNodeForm.tsx](file://frontend/src/features/editor/components/PropertyPanel/NodeForms/FactCheckNodeForm.tsx#L11-L83)
- [workflow.ts](file://frontend/src/types/workflow.ts#L27-L31)

## 结论
事实核查节点配置表单通过精心设计的控件实现了灵活且可靠的参数设置功能。搜索源多选框采用数组操作实现动态增删，滑块控件通过双向绑定和类型转换确保数据准确性，UI设计则兼顾美观与可用性。前后端通过标准化的数据结构和处理流程紧密协作，为用户提供直观高效的事实核查配置体验。
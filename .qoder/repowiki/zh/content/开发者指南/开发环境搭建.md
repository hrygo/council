# 开发环境搭建

<cite>
**本文档引用的文件**  
- [README.md](file://README.md)
- [Makefile](file://Makefile)
- [docker-compose.yml](file://docker-compose.yml)
- [.env.example](file://.env.example)
- [GEMINI.md](file://GEMINI.md)
- [config.go](file://internal/pkg/config/config.go)
- [main.go](file://cmd/council/main.go)
- [openai.go](file://internal/infrastructure/llm/openai.go)
- [gemini.go](file://internal/infrastructure/llm/gemini.go)
- [llm-providers.md](file://docs/guide/llm-providers.md)
- [model-selection-strategy.md](file://docs/guide/model-selection-strategy.md)
</cite>

## 目录
1. [简介](#简介)
2. [技术栈与版本要求](#技术栈与版本要求)
3. [环境依赖安装](#环境依赖安装)
4. [LLM提供商API密钥配置](#llm提供商api密钥配置)
5. [环境变量设置](#环境变量设置)
6. [通过Makefile快速启动](#通过makefile快速启动)
7. [Docker容器化开发环境](#docker容器化开发环境)
8. [常见问题排查](#常见问题排查)
9. [总结](#总结)

## 简介

本指南旨在为开发者提供完整的本地开发环境搭建流程，涵盖从基础依赖安装到服务启动的全部步骤。项目“理事会”（The Council）是一个可视化多智能体协作系统和个人私有思维库，支持通过自然语言生成工作流、多智能体辩论与决策、成本估算、三重记忆机制等高级功能。

通过本指南，您将能够：
- 安装并配置所有必要的开发工具和依赖
- 设置LLM提供商的API密钥
- 配置环境变量以连接数据库和AI服务
- 使用Makefile命令快速启动前后端服务
- 利用Docker容器化环境进行开发
- 解决常见的环境问题，如端口冲突和依赖不匹配

**Section sources**
- [README.md](file://README.md#L1-L352)

## 技术栈与版本要求

项目采用Go和React技术栈，后端使用Go 1.21+构建，前端基于React 19开发。数据库使用PostgreSQL 16（含pgvector扩展）进行向量存储，缓存服务使用Redis。系统支持多种LLM提供商，包括OpenAI、Gemini、DeepSeek、DashScope、Ollama等。

根据项目文档，以下是最低版本要求：

| 组件 | 版本要求 |
| :--- | :------- |
| Docker | ≥ 20.10 |
| Docker Compose | v2.x |
| Go | ≥ 1.21 |
| Node.js | ≥ 20 |
| PostgreSQL | 16+ |
| Redis | 最新稳定版 |

**Section sources**
- [README.md](file://README.md#L48-L56)
- [go.mod](file://go.mod#L3)

## 环境依赖安装

### 1. 安装Go 1.21+

Go语言是后端服务的开发语言。请确保安装Go 1.21或更高版本。

**macOS (使用Homebrew):**
```bash
brew install go@1.21
```

**Linux (Ubuntu/Debian):**
```bash
wget https://go.dev/dl/go1.21.linux-amd64.tar.gz
sudo tar -C /usr/local -xzf go1.21.linux-amd64.tar.gz
export PATH=$PATH:/usr/local/go/bin
```

**验证安装：**
```bash
go version
```

### 2. 安装Node.js 20+

Node.js用于前端开发服务器和构建工具。

**macOS (使用Homebrew):**
```bash
brew install node@20
```

**Linux (使用NodeSource):**
```bash
curl -fsSL https://deb.nodesource.com/setup_20.x | sudo -E bash -
sudo apt-get install -y nodejs
```

**验证安装：**
```bash
node --version
npm --version
```

### 3. 安装PostgreSQL 16+

PostgreSQL是主数据库，用于存储工作流、代理、会话等结构化数据。

**macOS:**
```bash
brew install postgresql@16
brew services start postgresql@16
```

**Linux (Ubuntu):**
```bash
sudo sh -c 'echo "deb http://apt.postgresql.org/pub/repos/apt $(lsb_release -cs)-pgdg main" > /etc/apt/sources.list.d/pgdg.list'
wget --quiet -O - https://www.postgresql.org/media/keys/ACCC4CF8.asc | sudo apt-key add -
sudo apt-get update
sudo apt-get install postgresql-16 postgresql-contrib-16
```

### 4. 安装Redis

Redis用于缓存和会话管理。

**macOS:**
```bash
brew install redis
brew services start redis
```

**Linux:**
```bash
sudo apt-get install redis-server
sudo systemctl start redis
```

**Section sources**
- [README.md](file://README.md#L48-L56)
- [docker-compose.yml](file://docker-compose.yml#L1-L24)

## LLM提供商API密钥配置

系统支持多种LLM提供商，包括Gemini、OpenAI、DeepSeek、SiliconFlow、DashScope和Ollama。您需要为所选提供商获取API密钥并进行配置。

### 1. 获取API密钥

#### Google Gemini
1. 访问 [Google AI Studio](https://aistudio.google.com/)
2. 创建项目并启用Gemini API
3. 生成API密钥

#### OpenAI
1. 访问 [OpenAI Platform](https://platform.openai.com/)
2. 登录账户
3. 在"API Keys"页面创建新密钥

#### DeepSeek
1. 访问 [DeepSeek API](https://platform.deepseek.com/)
2. 注册账户
3. 在控制台生成API密钥

#### SiliconFlow
1. 访问 [SiliconFlow](https://siliconflow.cn/)
2. 注册账户
3. 获取API密钥

#### DashScope (阿里云)
1. 访问 [阿里云百炼平台](https://dashscope.aliyun.com/)
2. 开通服务
3. 创建API密钥

### 2. 配置提供商支持

系统通过`internal/infrastructure/llm/`目录下的客户端实现支持不同提供商。例如：
- `gemini.go` 实现了Gemini客户端
- `openai.go` 实现了OpenAI兼容客户端
- `deepseek.go` 实现了DeepSeek客户端

这些客户端实现了统一的`LLMProvider`和`Embedder`接口，确保系统可以无缝切换不同提供商。

**Section sources**
- [llm-providers.md](file://docs/guide/llm-providers.md#L1-L186)
- [gemini.go](file://internal/infrastructure/llm/gemini.go#L1-L206)
- [openai.go](file://internal/infrastructure/llm/openai.go#L1-L154)

## 环境变量设置

环境变量用于配置数据库连接、LLM提供商、服务器端口等关键参数。

### 1. 创建环境文件

复制示例文件创建`.env`：
```bash
cp .env.example .env
```

### 2. 配置环境变量

编辑`.env`文件，根据需要修改以下配置：

```bash
# 数据库
DATABASE_URL=postgres://council:council_password@localhost:5432/council_db?sslmode=disable

# LLM 配置
LLM_PROVIDER=gemini
LLM_MODEL=gemini-2.0-flash
# LLM_API_KEY=your-api-key-here  # 或通过环境变量 GEMINI_API_KEY 设置

# Redis (可选)
REDIS_URL=localhost:6379

# 服务器
GIN_MODE=debug
PORT=8080
```

### 3. 配置LLM提供商密钥

在`.env`文件中添加各提供商的API密钥：

```bash
# Google Gemini
GEMINI_API_KEY=your_gemini_api_key

# DeepSeek
DEEPSEEK_API_KEY=your_deepseek_api_key

# SiliconFlow
SILICONFLOW_API_KEY=your_siliconflow_api_key

# OpenAI
OPENAI_API_KEY=your_openai_api_key

# 阿里云 DashScope
DASHSCOPE_API_KEY=your_dashscope_api_key

# 本地 Ollama
OLLAMA_BASE_URL=http://localhost:11434
```

### 4. 配置优先级

系统遵循以下配置优先级：
1. 环境变量（最高优先级）
2. `.env` 文件
3. 代码内默认值（最低优先级）

**Section sources**
- [.env.example](file://.env.example#L1-L21)
- [config.go](file://internal/pkg/config/config.go#L8-L133)

## 通过Makefile快速启动

Makefile提供了便捷的命令来管理开发环境。

### 1. 安装依赖

```bash
make install
```
此命令会：
- 下载Go模块依赖
- 安装前端npm包
- 创建`.env`文件（如果不存在）

### 2. 启动服务

#### 一键启动所有服务
```bash
make start
```
此命令按顺序启动：
1. Docker服务（PostgreSQL + Redis）
2. Go后端服务
3. React前端服务

#### 分步启动
```bash
# 1. 启动基础设施
make start-db

# 2. 启动后端
make start-backend

# 3. 启动前端
make start-frontend
```

### 3. 停止服务

```bash
make stop
```
此命令会停止所有服务。

### 4. 其他常用命令

```bash
make status        # 查看服务状态
make restart       # 重启所有服务
make test          # 运行所有测试
make lint          # 代码检查
make build         # 构建生产版本
make reset-db      # 重置数据库（删除所有数据）
```

**Section sources**
- [Makefile](file://Makefile#L1-L374)
- [README.md](file://README.md#L57-L90)

## Docker容器化开发环境

Docker提供了隔离的开发环境，避免本地依赖冲突。

### 1. Docker配置

`docker-compose.yml`定义了两个服务：

```yaml
services:
  db:
    image: pgvector/pgvector:pg16
    container_name: council_db
    ports:
      - "5432:5432"
    environment:
      POSTGRES_USER: council
      POSTGRES_PASSWORD: council_password
      POSTGRES_DB: council_db
    volumes:
      - postgres_data:/var/lib/postgresql/data
    restart: always

  redis:
    image: redis:alpine
    container_name: council_redis
    ports:
      - "6379:6379"
    restart: always

volumes:
  postgres_data:
```

### 2. 使用Docker开发

#### 启动Docker服务
```bash
make start-db
```
或直接使用Docker Compose：
```bash
docker compose up -d
```

#### 挂载代码卷进行热重载

为了实现Go后端的热重载，可以修改`docker-compose.yml`添加卷挂载：

```yaml
services:
  backend:
    build: .
    volumes:
      - ./cmd:/app/cmd
      - ./internal:/app/internal
    ports:
      - "8080:8080"
    environment:
      - DATABASE_URL=postgres://council:council_password@db:5432/council_db?sslmode=disable
    depends_on:
      - db
      - redis
```

#### 开发工作流

1. 启动数据库和Redis：
   ```bash
   make start-db
   ```

2. 在主机上启动Go后端（利用本地Go环境）：
   ```bash
   make start-backend
   ```

3. 在主机上启动前端：
   ```bash
   make start-frontend
   ```

这种方式结合了Docker的环境一致性与本地开发的灵活性。

**Section sources**
- [docker-compose.yml](file://docker-compose.yml#L1-L24)
- [Makefile](file://Makefile#L71-L93)

## 常见问题排查

### 1. 端口冲突

**症状**：服务无法启动，提示端口已被占用。

**解决方案**：
- 检查端口占用：
  ```bash
  lsof -i :8080  # 检查后端端口
  lsof -i :5173  # 检查前端端口
  lsof -i :5432  # 检查数据库端口
  ```
- 终止占用进程：
  ```bash
  lsof -ti :8080 | xargs kill -9
  ```
- 修改配置文件中的端口号。

### 2. 依赖版本不匹配

**症状**：`go mod download`或`npm install`失败。

**解决方案**：
- 清理缓存后重试：
  ```bash
  make clean
  make install
  ```
- 检查Go版本是否符合要求：
  ```bash
  go version
  ```
- 检查Node.js版本：
  ```bash
  node --version
  ```

### 3. 数据库连接失败

**症状**：后端启动时报错"Failed to initialize database"。

**解决方案**：
- 确认PostgreSQL服务已启动：
  ```bash
  brew services list | grep postgresql  # macOS
  systemctl status postgresql           # Linux
  ```
- 检查`.env`文件中的`DATABASE_URL`是否正确。
- 使用Docker时，确认容器正常运行：
  ```bash
  docker compose ps
  ```

### 4. LLM API调用失败

**症状**：401 Unauthorized或模型不存在。

**解决方案**：
- 检查API密钥是否正确配置。
- 确认密钥有对应模型的访问权限。
- 检查网络连接，必要时配置代理。
- 对于Ollama，确认服务已启动：
  ```bash
  curl http://localhost:11434/api/tags
  ```

### 5. 前端无法连接后端

**症状**：前端报错"Network Error"或"Connection Refused"。

**解决方案**：
- 确认后端服务正在运行：
  ```bash
  make status
  ```
- 检查前端配置的API地址是否正确。
- 确认防火墙未阻止相应端口。

**Section sources**
- [README.md](file://README.md#L57-L90)
- [Makefile](file://Makefile#L52-L65)
- [config.go](file://internal/pkg/config/config.go#L45-L133)

## 总结

本指南详细介绍了“理事会”项目的开发环境搭建流程。通过安装Go、Node.js、PostgreSQL和Redis等基础依赖，配置LLM提供商API密钥，设置环境变量，并利用Makefile和Docker进行服务管理，开发者可以快速建立本地开发环境。

关键要点：
- 使用`make install`安装所有依赖
- 通过`.env`文件配置环境变量和API密钥
- 使用`make start`一键启动所有服务
- Docker提供了隔离的数据库和缓存环境
- Makefile提供了丰富的开发命令

遵循本指南，您将能够顺利搭建开发环境，开始对“理事会”项目进行开发和贡献。

**Section sources**
- [README.md](file://README.md#L1-L352)
- [Makefile](file://Makefile#L1-L374)
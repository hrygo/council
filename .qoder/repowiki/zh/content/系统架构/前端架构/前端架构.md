# 前端架构

<cite>
**本文档中引用的文件**  
- [main.tsx](file://frontend/src/main.tsx)
- [App.tsx](file://frontend/src/App.tsx)
- [package.json](file://frontend/package.json)
- [vite.config.ts](file://frontend/vite.config.ts)
- [tailwind.config.js](file://frontend/tailwind.config.js)
- [useConfigStore.ts](file://frontend/src/stores/useConfigStore.ts)
- [useWorkflowRunStore.ts](file://frontend/src/stores/useWorkflowRunStore.ts)
- [WorkflowEditor.tsx](file://frontend/src/features/editor/WorkflowEditor.tsx)
- [MeetingRoom.tsx](file://frontend/src/features/meeting/MeetingRoom.tsx)
- [useWebSocketRouter.ts](file://frontend/src/hooks/useWebSocketRouter.ts)
- [WorkflowCanvas.tsx](file://frontend/src/components/workflow/WorkflowCanvas.tsx)
- [ChatPanel.tsx](file://frontend/src/components/chat/ChatPanel.tsx)
- [PropertyPanel.tsx](file://frontend/src/features/editor/components/PropertyPanel/PropertyPanel.tsx)
- [graphUtils.ts](file://frontend/src/utils/graphUtils.ts)
- [workflow.ts](file://frontend/src/types/workflow.ts)
</cite>

## 目录
1. [引言](#引言)
2. [项目结构](#项目结构)
3. [双模前端设计](#双模前端设计)
4. [状态管理](#状态管理)
5. [工作流画布实现](#工作流画布实现)
6. [核心组件分析](#核心组件分析)
7. [通信机制](#通信机制)
8. [技术栈选型](#技术栈选型)
9. [性能优化策略](#性能优化策略)

## 引言
The Council 前端架构采用双模设计，支持构建模式（Builder）与运行模式（Runner）的分离。系统通过 React、Vite 和 Tailwind CSS 构建现代化用户界面，利用 Zustand 进行全局状态管理，并通过 React Flow 实现可视化工作流编辑。前端通过 REST API 进行配置管理，通过 WebSocket 接收实时执行流，实现了高效、响应式的用户体验。

## 项目结构
The Council 前端项目采用功能模块化组织方式，主要目录结构如下：
- `components/`: 通用UI组件
- `features/`: 功能模块（编辑器、会议、代理、组等）
- `stores/`: Zustand 状态管理
- `hooks/`: 自定义 React Hooks
- `types/`: TypeScript 类型定义
- `utils/`: 工具函数

**Section sources**
- [App.tsx](file://frontend/src/App.tsx#L8-L15)

## 双模前端设计
The Council 前端采用构建模式（Builder）与运行模式（Runner）分离的设计策略。构建模式用于创建工作流，运行模式用于执行和监控工作流。

```mermaid
graph TD
A[前端应用] --> B[构建模式]
A --> C[运行模式]
B --> D[WorkflowEditor]
B --> E[PropertyPanel]
B --> F[TemplateSidebar]
C --> G[MeetingRoom]
C --> H[ChatPanel]
C --> I[WorkflowCanvas]
C --> J[DocumentReader]
```

**Diagram sources**
- [WorkflowEditor.tsx](file://frontend/src/features/editor/WorkflowEditor.tsx#L15-L271)
- [MeetingRoom.tsx](file://frontend/src/features/meeting/MeetingRoom.tsx#L80-L233)

**Section sources**
- [WorkflowEditor.tsx](file://frontend/src/features/editor/WorkflowEditor.tsx#L15-L271)
- [MeetingRoom.tsx](file://frontend/src/features/meeting/MeetingRoom.tsx#L80-L233)

## 状态管理
前端使用 Zustand 进行全局状态管理，实现了轻量级、高效的状态管理方案。主要状态存储包括配置状态、会话状态和工作流运行状态。

```mermaid
classDiagram
class useConfigStore {
+theme : 'light' | 'dark' | 'system'
+language : 'zh-CN' | 'en-US'
+godMode : boolean
+setTheme(theme)
+setLanguage(lang)
+toggleGodMode()
}
class useSessionStore {
+currentSession : Session
+messageGroups : MessageGroup[]
+appendMessage(msg)
+updateNodeStatus(nodeId, status)
+updateTokenUsage(nodeId, agentId, usage)
}
class useWorkflowRunStore {
+nodes : Node[]
+edges : Edge[]
+activeNodeIds : Set<string>
+executionStatus : 'idle' | 'running' | 'paused' | 'completed' | 'failed'
+loadWorkflow(nodes, edges)
+updateNodeStatus(nodeId, status)
+setExecutionStatus(status)
+sendControl(sessionId, action)
}
useConfigStore --> useSessionStore : "影响UI主题"
useWorkflowRunStore --> useSessionStore : "同步节点状态"
```

**Diagram sources**
- [useConfigStore.ts](file://frontend/src/stores/useConfigStore.ts#L5-L35)
- [useWorkflowRunStore.ts](file://frontend/src/stores/useWorkflowRunStore.ts#L14-L301)

**Section sources**
- [useConfigStore.ts](file://frontend/src/stores/useConfigStore.ts#L5-L35)
- [useWorkflowRunStore.ts](file://frontend/src/stores/useWorkflowRunStore.ts#L14-L301)

## 工作流画布实现
工作流画布基于 React Flow 实现，支持可视化编辑和运行时监控。画布组件根据模式（编辑或运行）动态调整交互行为。

```mermaid
sequenceDiagram
participant UI as "用户界面"
participant Canvas as "WorkflowCanvas"
participant Store as "useWorkflowRunStore"
participant Utils as "graphUtils"
UI->>Canvas : 初始化画布
Canvas->>Utils : transformToReactFlow(graph)
Utils-->>Canvas : 返回nodes和edges
Canvas->>Store : loadWorkflow(nodes, edges)
Store-->>Canvas : 更新状态
Canvas->>UI : 渲染React Flow组件
UI->>Canvas : 用户交互点击、连接
Canvas->>Store : 更新节点/边状态
Store-->>Canvas : 返回更新后的状态
Canvas->>UI : 重新渲染
```

**Diagram sources**
- [WorkflowCanvas.tsx](file://frontend/src/components/workflow/WorkflowCanvas.tsx#L53-L149)
- [graphUtils.ts](file://frontend/src/utils/graphUtils.ts#L20-L131)

**Section sources**
- [WorkflowCanvas.tsx](file://frontend/src/components/workflow/WorkflowCanvas.tsx#L53-L149)
- [graphUtils.ts](file://frontend/src/utils/graphUtils.ts#L20-L131)

## 核心组件分析
### ChatPanel 分析
ChatPanel 组件负责显示会议中的消息流，支持实时更新和自动滚动。

```mermaid
flowchart TD
Start([ChatPanel 初始化]) --> LoadMessages["加载消息组"]
LoadMessages --> CheckEmpty{"消息为空?"}
CheckEmpty --> |是| ShowPlaceholder["显示等待提示"]
CheckEmpty --> |否| RenderGroups["渲染消息组"]
RenderGroups --> AutoScroll["自动滚动到底部"]
AutoScroll --> End([组件渲染完成])
subgraph "消息更新"
MessageUpdate["收到新消息"] --> UpdateStore["更新会话存储"]
UpdateStore --> Rerender["重新渲染组件"]
Rerender --> AutoScroll
end
```

**Diagram sources**
- [ChatPanel.tsx](file://frontend/src/components/chat/ChatPanel.tsx#L10-L77)

**Section sources**
- [ChatPanel.tsx](file://frontend/src/components/chat/ChatPanel.tsx#L10-L77)

### WorkflowCanvas 分析
WorkflowCanvas 组件是工作流可视化的核心，支持编辑和只读两种模式。

```mermaid
classDiagram
class WorkflowCanvas {
+readOnly : boolean
+fullscreen : boolean
+graph : BackendGraph
+onInit(instance)
+onNodeClick(event, node)
+onPaneClick(event)
}
class ReactFlow {
+nodes : Node[]
+edges : Edge[]
+nodeTypes : NodeTypes
+onNodesChange
+onEdgesChange
+onConnect
}
class Background {
+color : string
+gap : number
}
class Controls {
+showInteractive : boolean
}
WorkflowCanvas --> ReactFlow : "使用"
WorkflowCanvas --> Background : "使用"
WorkflowCanvas --> Controls : "使用"
WorkflowCanvas --> CustomNodes : "使用"
```

**Diagram sources**
- [WorkflowCanvas.tsx](file://frontend/src/components/workflow/WorkflowCanvas.tsx#L53-L149)

**Section sources**
- [WorkflowCanvas.tsx](file://frontend/src/components/workflow/WorkflowCanvas.tsx#L53-L149)

### PropertyPanel 分析
PropertyPanel 组件提供节点属性编辑功能，支持多种节点类型的表单渲染。

```mermaid
flowchart TD
A[PropertyPanel] --> B{节点类型判断}
B --> |vote| C[VoteNodeForm]
B --> |loop| D[LoopNodeForm]
B --> |fact_check| E[FactCheckNodeForm]
B --> |human_review| F[HumanReviewNodeForm]
B --> |agent| G[默认配置]
B --> |其他| H[无配置提示]
I[通用功能] --> J[节点名称输入]
I --> K[删除节点按钮]
I --> L[关闭面板按钮]
C --> M[阈值设置]
C --> N[投票类型选择]
C --> O[代理选择]
D --> P[最大轮数]
D --> Q[退出条件]
D --> R[代理配对]
```

**Diagram sources**
- [PropertyPanel.tsx](file://frontend/src/features/editor/components/PropertyPanel/PropertyPanel.tsx#L18-L86)

**Section sources**
- [PropertyPanel.tsx](file://frontend/src/features/editor/components/PropertyPanel/PropertyPanel.tsx#L18-L86)

## 通信机制
前端通过 REST API 进行配置管理，通过 WebSocket 接收实时执行流。

```mermaid
sequenceDiagram
participant Frontend as "前端"
participant Backend as "后端"
Frontend->>Backend : GET /api/v1/workflows/{id}
Backend-->>Frontend : 返回工作流定义
Frontend->>Backend : POST /api/v1/workflows
Backend-->>Frontend : 创建工作流成功
Frontend->>Backend : PUT /api/v1/workflows/{id}
Backend-->>Frontend : 更新工作流成功
Frontend->>Backend : WebSocket 连接 /ws
Backend->>Frontend : token_stream 事件
Backend->>Frontend : node_state_change 事件
Backend->>Frontend : execution : paused 事件
Backend->>Frontend : human_interaction_required 事件
Frontend->>Backend : POST /api/v1/sessions/{id}/control
Backend-->>Frontend : 控制命令响应
```

**Diagram sources**
- [useWebSocketRouter.ts](file://frontend/src/hooks/useWebSocketRouter.ts#L13-L126)
- [WorkflowEditor.tsx](file://frontend/src/features/editor/WorkflowEditor.tsx#L69-L133)

**Section sources**
- [useWebSocketRouter.ts](file://frontend/src/hooks/useWebSocketRouter.ts#L13-L126)
- [WorkflowEditor.tsx](file://frontend/src/features/editor/WorkflowEditor.tsx#L69-L133)

## 技术栈选型
### 前端技术栈
The Council 前端采用现代化技术栈，确保开发效率和运行性能。

```mermaid
erDiagram
REACT {
string version "19.2.0"
string description "UI组件化"
}
VITE {
string version "7.2.4"
string description "构建工具"
}
TAILWIND {
string version "3.4.17"
string description "CSS框架"
}
ZUSTAND {
string version "5.0.9"
string description "状态管理"
}
REACT_FLOW {
string version "12.10.0"
string description "工作流画布"
}
TANSTACK_QUERY {
string version "5.90.12"
string description "数据获取"
}
I18NEXT {
string version "25.7.3"
string description "国际化"
}
REACT_ROUTER {
string version "7.10.1"
string description "路由管理"
}
REACT ||--o{ VITE : "使用"
VITE ||--o{ TAILWIND : "集成"
TAILWIND ||--o{ ZUSTAND : "配合使用"
ZUSTAND ||--o{ REACT_FLOW : "状态共享"
REACT_FLOW ||--o{ TANSTACK_QUERY : "数据获取"
TANSTACK_QUERY ||--o{ I18NEXT : "多语言支持"
I18NEXT ||--o{ REACT_ROUTER : "路由国际化"
```

**Diagram sources**
- [package.json](file://frontend/package.json#L15-L34)
- [vite.config.ts](file://frontend/vite.config.ts#L1-L28)
- [tailwind.config.js](file://frontend/tailwind.config.js#L1-L13)

**Section sources**
- [package.json](file://frontend/package.json#L15-L34)
- [vite.config.ts](file://frontend/vite.config.ts#L1-L28)
- [tailwind.config.js](file://frontend/tailwind.config.js#L1-L13)

## 性能优化策略
前端实现了多种性能优化策略，确保大型工作流的流畅运行。

```mermaid
flowchart TD
A[性能优化策略] --> B[代码分割]
A --> C[长列表虚拟化]
A --> D[状态管理优化]
A --> E[WebSocket 消息批处理]
A --> F[组件懒加载]
B --> G[动态导入功能模块]
C --> H[虚拟滚动消息列表]
D --> I[使用immer进行不可变更新]
D --> J[选择性状态订阅]
E --> K[消息合并与节流]
F --> L[路由级代码分割]
M[性能监控] --> N[加载时间统计]
M --> O[渲染性能分析]
M --> P[内存使用监控]
```

**Diagram sources**
- [useWorkflowRunStore.ts](file://frontend/src/stores/useWorkflowRunStore.ts#L2-L301)
- [MeetingRoom.tsx](file://frontend/src/features/meeting/MeetingRoom.tsx#L1-L233)
- [ChatPanel.tsx](file://frontend/src/components/chat/ChatPanel.tsx#L1-L77)

**Section sources**
- [useWorkflowRunStore.ts](file://frontend/src/stores/useWorkflowRunStore.ts#L2-L301)
- [MeetingRoom.tsx](file://frontend/src/features/meeting/MeetingRoom.tsx#L1-L233)
- [ChatPanel.tsx](file://frontend/src/components/chat/ChatPanel.tsx#L1-L77)
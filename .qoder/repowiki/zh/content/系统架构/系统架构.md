# 系统架构

<cite>
**本文档中引用的文件**  
- [main.go](file://cmd/council/main.go)
- [seeder.go](file://internal/resources/seeder.go)
- [engine.go](file://internal/core/workflow/engine.go)
- [workflow.go](file://internal/api/handler/workflow.go)
- [hub.go](file://internal/api/ws/hub.go)
- [config.go](file://internal/pkg/config/config.go)
- [entity.go](file://internal/core/agent/entity.go)
- [entity.go](file://internal/core/group/entity.go)
- [service.go](file://internal/core/memory/service.go)
- [factory.go](file://internal/core/workflow/nodes/factory.go)
- [versioning.go](file://internal/core/middleware/versioning.go)
- [session.go](file://internal/core/workflow/session.go)
- [App.tsx](file://frontend/src/App.tsx)
- [package.json](file://frontend/package.json)
- [postgres.go](file://internal/infrastructure/db/postgres.go)
</cite>

## 目录
1. [引言](#引言)
2. [项目结构](#项目结构)
3. [核心组件](#核心组件)
4. [架构概述](#架构概述)
5. [详细组件分析](#详细组件分析)
6. [依赖分析](#依赖分析)
7. [性能考虑](#性能考虑)
8. [故障排除指南](#故障排除指南)
9. [结论](#结论)

## 引言
The Council 是一个基于多智能体协作的决策系统，采用分层设计实现骨架层（SKELETON）与实例层（INSTANCE）的解耦。系统通过Go语言后端与React前端SPA实现前后端分离，利用REST API和WebSocket进行通信。本架构文档深入描述了系统的分层设计、核心组件交互、事件驱动的工作流执行流程以及技术选型理由。

## 项目结构
The Council项目采用清晰的分层架构，主要分为前端、后端核心逻辑和基础设施层。前端使用React构建SPA应用，后端采用Go语言实现，分为API接口、核心业务逻辑、基础设施和资源管理等模块。

```mermaid
graph TD
subgraph "前端"
ReactSPA[React SPA]
end
subgraph "后端"
API[REST API]
WebSocket[WebSocket]
Core[核心模块]
Infrastructure[基础设施]
Resources[资源管理]
end
ReactSPA --> API
ReactSPA --> WebSocket
API --> Core
WebSocket --> Core
Core --> Infrastructure
Core --> Resources
```

**Diagram sources**
- [App.tsx](file://frontend/src/App.tsx)
- [main.go](file://cmd/council/main.go)

**Section sources**
- [main.go](file://cmd/council/main.go#L21-L148)
- [App.tsx](file://frontend/src/App.tsx#L1-L85)

## 核心组件
The Council系统的核心组件包括Agent、Group、Workflow和Memory模块，这些模块具有高内聚低耦合的特性。系统启动时通过seeder加载默认配置，实现骨架层与实例层的分离。

**Section sources**
- [seeder.go](file://internal/resources/seeder.go#L1-L420)
- [entity.go](file://internal/core/agent/entity.go#L1-L37)
- [entity.go](file://internal/core/group/entity.go#L1-L19)
- [service.go](file://internal/core/memory/service.go#L1-L209)

## 架构概述
The Council采用分层架构设计，实现了骨架层与实例层的解耦。骨架层包含系统默认的智能体、组和工作流模板，而实例层则存储用户创建的具体实例。这种设计使得系统既具有预设的功能框架，又能灵活适应不同的使用场景。

```mermaid
graph TB
subgraph "前端层"
ReactSPA[React SPA]
Zustand[Zustand状态管理]
end
subgraph "API层"
REST[REST API]
WebSocket[WebSocket]
end
subgraph "核心业务层"
Workflow[工作流引擎]
Agent[智能体管理]
Group[组管理]
Memory[记忆系统]
end
subgraph "基础设施层"
Gin[Gin框架]
PostgreSQL[PostgreSQL数据库]
Redis[Redis缓存]
pgvector[pgvector扩展]
end
ReactSPA --> REST
ReactSPA --> WebSocket
REST --> Workflow
WebSocket --> Workflow
Workflow --> Agent
Workflow --> Group
Workflow --> Memory
Agent --> PostgreSQL
Group --> PostgreSQL
Memory --> PostgreSQL
Memory --> Redis
Memory --> pgvector
```

**Diagram sources**
- [main.go](file://cmd/council/main.go#L21-L148)
- [package.json](file://frontend/package.json#L1-L60)

## 详细组件分析

### 骨架层与实例层解耦设计
The Council系统通过seeder机制实现骨架层与实例层的解耦设计。骨架层包含系统预设的智能体、组和工作流模板，而实例层则存储用户创建的具体实例。

```mermaid
classDiagram
class Seeder {
+db *pgxpool.Pool
+cfg *Config
+SeedAll(ctx context.Context) error
+SeedAgents(ctx context.Context) error
+SeedGroups(ctx context.Context) error
+SeedWorkflows(ctx context.Context) error
+SeedLLMOptions(ctx context.Context) error
}
class Config {
+Port string
+DatabaseURL string
+LLM LLMConfig
+Embedding EmbeddingConfig
}
Seeder --> Config : "依赖"
```

**Diagram sources**
- [seeder.go](file://internal/resources/seeder.go#L1-L420)
- [config.go](file://internal/pkg/config/config.go#L1-L133)

**Section sources**
- [seeder.go](file://internal/resources/seeder.go#L1-L420)
- [config.go](file://internal/pkg/config/config.go#L1-L133)

### Agent、Group、Workflow、Memory模块分析
The Council的核心模块具有高内聚低耦合的特性，每个模块都专注于特定的功能领域。

#### Agent模块
Agent模块定义了AI智能体的属性和能力，包括名称、头像、描述、人格提示和模型配置等。

```mermaid
classDiagram
class Agent {
+ID uuid.UUID
+Name string
+Avatar *string
+Description *string
+PersonaPrompt string
+ModelConfig ModelConfig
+Capabilities Capabilities
+CreatedAt time.Time
+UpdatedAt time.Time
}
class ModelConfig {
+Provider string
+Model string
+Temperature float64
+TopP float64
+MaxTokens int
}
class Capabilities {
+WebSearch bool
+SearchProvider string
+CodeExecution bool
}
Agent --> ModelConfig : "包含"
Agent --> Capabilities : "包含"
```

**Diagram sources**
- [entity.go](file://internal/core/agent/entity.go#L1-L37)

**Section sources**
- [entity.go](file://internal/core/agent/entity.go#L1-L37)

#### Group模块
Group模块代表协作组（项目/上下文），包含组名、图标、系统提示和默认智能体ID列表等属性。

```mermaid
classDiagram
class Group {
+ID uuid.UUID
+Name string
+Icon *string
+SystemPrompt *string
+DefaultAgentIDs []uuid.UUID
+CreatedAt time.Time
+UpdatedAt time.Time
}
```

**Diagram sources**
- [entity.go](file://internal/core/group/entity.go#L1-L19)

**Section sources**
- [entity.go](file://internal/core/group/entity.go#L1-L19)

#### Workflow模块
Workflow模块负责工作流的执行，采用事件驱动的架构，从用户输入到智能体调用、节点处理、状态更新的全链路。

```mermaid
sequenceDiagram
participant Frontend as "前端"
participant API as "REST API"
participant Engine as "工作流引擎"
participant Node as "节点处理器"
Frontend->>API : POST /api/v1/workflows/execute
API->>Engine : 创建会话并启动引擎
Engine->>Engine : 验证工作流图
Engine->>Node : 执行起始节点
Node->>Node : 处理节点逻辑
Node-->>Engine : 返回输出
Engine->>Engine : 更新节点状态
Engine->>Engine : 触发下一个节点
loop 直到工作流完成
Engine->>Node : 执行下一个节点
end
Engine-->>API : 工作流完成
API-->>Frontend : 返回会话ID和状态
```

**Diagram sources**
- [engine.go](file://internal/core/workflow/engine.go#L1-L246)
- [workflow.go](file://internal/api/handler/workflow.go#L1-L246)

**Section sources**
- [engine.go](file://internal/core/workflow/engine.go#L1-L246)
- [workflow.go](file://internal/api/handler/workflow.go#L1-L246)

#### Memory模块
Memory模块实现了三级记忆系统，包括隔离区（Quarantine）、工作记忆（Working Memory）和长期记忆（Long-term Memory）。

```mermaid
flowchart TD
Start([输入内容]) --> Quarantine["隔离区 (PostgreSQL)"]
Quarantine --> |低置信度| Discard["丢弃"]
Quarantine --> |高置信度| WorkingMemory["工作记忆 (Redis)"]
WorkingMemory --> |内容质量高| Promote["提升到长期记忆"]
Promote --> LongTermMemory["长期记忆 (PostgreSQL + pgvector)"]
LongTermMemory --> Retrieve["检索相关记忆"]
Retrieve --> Response["生成响应"]
```

**Diagram sources**
- [service.go](file://internal/core/memory/service.go#L1-L209)

**Section sources**
- [service.go](file://internal/core/memory/service.go#L1-L209)

### 系统启动与配置加载
系统启动时通过seeder加载默认配置，包括智能体、组、工作流模板和LLM选项。

```mermaid
flowchart TD
Start([系统启动]) --> LoadConfig["加载配置文件"]
LoadConfig --> InitDB["初始化数据库"]
InitDB --> SeedData["加载默认数据"]
SeedData --> SeedAgents["加载默认智能体"]
SeedData --> SeedGroups["加载默认组"]
SeedData --> SeedWorkflows["加载默认工作流"]
SeedData --> SeedLLMOptions["加载LLM选项"]
SeedLLMOptions --> InitRedis["初始化Redis"]
InitRedis --> StartServer["启动服务器"]
StartServer --> End([系统就绪])
```

**Diagram sources**
- [main.go](file://cmd/council/main.go#L21-L148)
- [seeder.go](file://internal/resources/seeder.go#L1-L420)

**Section sources**
- [main.go](file://cmd/council/main.go#L21-L148)
- [seeder.go](file://internal/resources/seeder.go#L1-L420)

### 前后端分离架构
The Council采用前后端分离架构，前端React SPA通过REST API和WebSocket与Go后端通信。

```mermaid
graph TD
subgraph "前端"
ReactSPA[React SPA]
Zustand[Zustand状态管理]
end
subgraph "后端"
Gin[Gin框架]
REST[REST API]
WebSocket[WebSocket]
Core[核心业务逻辑]
PostgreSQL[PostgreSQL]
Redis[Redis]
end
ReactSPA --> REST
ReactSPA --> WebSocket
REST --> Core
WebSocket --> Core
Core --> PostgreSQL
Core --> Redis
```

**Diagram sources**
- [main.go](file://cmd/council/main.go#L21-L148)
- [App.tsx](file://frontend/src/App.tsx#L1-L85)

**Section sources**
- [main.go](file://cmd/council/main.go#L21-L148)
- [App.tsx](file://frontend/src/App.tsx#L1-L85)

### 事件驱动的工作流执行流程
The Council采用事件驱动的工作流执行流程，从用户输入到智能体调用、节点处理、状态更新的全链路。

```mermaid
sequenceDiagram
participant User as "用户"
participant Frontend as "前端"
participant Backend as "后端"
participant Agent as "智能体"
User->>Frontend : 输入问题
Frontend->>Backend : 发送执行请求
Backend->>Backend : 创建工作流会话
Backend->>Backend : 启动工作流引擎
Backend->>Backend : 执行并行分析节点
Backend->>Agent : 调用肯定方智能体
Backend->>Agent : 调用否定方智能体
Agent-->>Backend : 返回分析结果
Backend->>Agent : 调用裁决方智能体
Agent-->>Backend : 返回裁决报告
Backend->>Frontend : 通过WebSocket发送状态更新
Frontend->>User : 显示最终报告
```

**Diagram sources**
- [engine.go](file://internal/core/workflow/engine.go#L1-L246)
- [workflow.go](file://internal/api/handler/workflow.go#L1-L246)
- [hub.go](file://internal/api/ws/hub.go#L1-L125)

**Section sources**
- [engine.go](file://internal/core/workflow/engine.go#L1-L246)
- [workflow.go](file://internal/api/handler/workflow.go#L1-L246)
- [hub.go](file://internal/api/ws/hub.go#L1-L125)

## 依赖分析
The Council系统的组件之间通过清晰的依赖关系进行交互，确保了高内聚低耦合的设计原则。

```mermaid
graph TD
main.go --> config.go
main.go --> postgres.go
main.go --> seeder.go
main.go --> workflow.go
main.go --> hub.go
workflow.go --> engine.go
workflow.go --> factory.go
engine.go --> session.go
engine.go --> versioning.go
seeder.go --> config.go
factory.go --> service.go
service.go --> postgres.go
service.go --> redis.go
```

**Diagram sources**
- [main.go](file://cmd/council/main.go#L21-L148)
- [config.go](file://internal/pkg/config/config.go#L1-L133)
- [postgres.go](file://internal/infrastructure/db/postgres.go#L1-L66)

**Section sources**
- [main.go](file://cmd/council/main.go#L21-L148)
- [config.go](file://internal/pkg/config/config.go#L1-L133)
- [postgres.go](file://internal/infrastructure/db/postgres.go#L1-L66)

## 性能考虑
The Council系统在性能方面进行了多项优化，包括使用Redis作为工作记忆的缓存层，使用pgvector扩展实现高效的向量相似性搜索，以及通过Gin框架实现高性能的HTTP路由。

## 故障排除指南
当系统出现故障时，可以按照以下步骤进行排查：
1. 检查数据库连接是否正常
2. 检查Redis服务是否正常运行
3. 检查LLM API密钥是否正确配置
4. 查看系统日志以获取详细的错误信息

**Section sources**
- [main.go](file://cmd/council/main.go#L21-L148)
- [config.go](file://internal/pkg/config/config.go#L1-L133)

## 结论
The Council系统通过分层设计实现了骨架层与实例层的解耦，核心组件具有高内聚低耦合的特性。系统采用前后端分离架构，前端React SPA通过REST API和WebSocket与Go后端通信。事件驱动的工作流执行流程确保了从用户输入到智能体调用、节点处理、状态更新的全链路高效运行。技术选型方面，Gin框架提供了高性能的HTTP路由，Zustand实现了前端状态管理，pgvector扩展支持高效的向量相似性搜索。
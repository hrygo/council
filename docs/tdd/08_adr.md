# 8. 技术决策记录 (Architecture Decision Records)

本章节记录关键技术选型及其详细理由，为后续开发和维护提供决策依据。

### ADR-001: 数据库选型 — PostgreSQL + pgvector

| 属性     | 内容                               |
| -------- | ---------------------------------- |
| **决策** | 使用 PostgreSQL 15 + pgvector 扩展 |
| **状态** | ✅ 已采纳                           |
| **日期** | 2024-12                            |

**背景**：系统需要同时存储结构化数据（群组、Agent、会议）和向量数据（记忆嵌入）。

**候选方案对比**：

| 方案                              | 优势                          | 劣势                                         |
| --------------------------------- | ----------------------------- | -------------------------------------------- |
| **SQLite + Faiss**                | 零依赖、嵌入式                | 无原生向量支持、需维护两套存储、无法事务一致 |
| **PostgreSQL + pgvector**         | 单库统一、ACID 保证、成熟生态 | 需要额外部署                                 |
| **MongoDB + Atlas Vector Search** | Schema 灵活                   | 云依赖强、本地部署复杂                       |

**决策理由**：
1. pgvector 提供原生向量索引（IVFFlat/HNSW），无需维护额外搜索引擎
2. GORM 对 PostgreSQL 支持最完善
3. Docker 部署成熟，后期可切换 Embedded Postgres 降低用户门槛
4. 向量与关系数据在同一事务中操作，保证一致性

### ADR-002: 后端框架选型 — Gin

| 属性     | 内容                              |
| -------- | --------------------------------- |
| **决策** | 使用 Gin 作为 HTTP/WebSocket 框架 |
| **状态** | ✅ 已采纳                          |

**候选方案对比**：

| 方案       | 优势                         | 劣势                       |
| ---------- | ---------------------------- | -------------------------- |
| **Gin**    | 高性能、中间件丰富、社区活跃 | 非标准库                   |
| **Chi**    | 轻量、标准库兼容             | WebSocket 需额外集成       |
| **Fiber**  | 极致性能                     | 非 net/http 兼容、生态较小 |
| **标准库** | 零依赖                       | 路由功能弱、开发效率低     |

**决策理由**：
1. Gin 的路由性能满足需求（百万级 QPS）
2. 内置 WebSocket 升级支持，配合 gorilla/websocket
3. 中间件生态完善（CORS、Recovery、Logger）
4. 团队熟悉度高

### ADR-003: 前后端架构 — React SPA + Go API 分离模式

| 属性     | 内容                                                      |
| -------- | --------------------------------------------------------- |
| **决策** | 采用 React SPA 前端 + Go Backend API 的纯 WebApp 分离架构 |
| **状态** | ✅ 已采纳                                                  |

**候选方案对比**：

| 方案                   | 优势                               | 劣势                       |
| ---------------------- | ---------------------------------- | -------------------------- |
| **React SPA + Go API** | 前后端独立部署、技术栈纯粹、易扩展 | 需处理 CORS、首屏加载稍慢  |
| **Next.js SSR**        | SEO 友好、首屏快                   | Go 后端需适配、增加复杂度  |
| **Go 模板渲染**        | 单体简单                           | 前端交互能力弱、开发效率低 |
| **Electron 桌面应用**  | 本地化、离线能力                   | 部署复杂、跨平台维护成本高 |

**决策理由**：
1. React SPA 提供最佳交互体验，适合复杂工作流编辑场景
2. Go API 独立部署，支持 Docker 容器化，运维标准化
3. 前后端分离便于团队协作，可独立迭代发布
4. 纯 WebApp 模式降低用户使用门槛，浏览器即可访问

### ADR-004: 前端状态管理 — Zustand

| 属性     | 内容                    |
| -------- | ----------------------- |
| **决策** | 使用 Zustand 替代 Redux |
| **状态** | ✅ 已采纳                |

**决策理由**：
1. API 极简，无 boilerplate（比 Redux Toolkit 更轻量）
2. 内置 persist 中间件，布局状态持久化零配置
3. 支持中间件组合（devtools、immer）
4. TypeScript 类型推导优秀
5. Bundle size 仅 1.1KB（Redux Toolkit 12KB+）

### ADR-005: 流程编辑器 — React Flow

| 属性     | 内容                               |
| -------- | ---------------------------------- |
| **决策** | 使用 React Flow 作为工作流画布组件 |
| **状态** | ✅ 已采纳                           |

**候选方案对比**：

| 方案           | 优势                                 | 劣势                    |
| -------------- | ------------------------------------ | ----------------------- |
| **React Flow** | React 原生、自定义节点简单、MIT 开源 | 高级功能需 Pro 版       |
| **AntV X6**    | 功能全面、中文文档                   | Bundle 较大、学习曲线陡 |
| **JointJS**    | 成熟稳定                             | 商业授权昂贵            |
| **自研**       | 完全可控                             | 开发周期长              |

**决策理由**：
1. 自定义节点开发体验最佳，符合 React 心智模型
2. 内置小地图、缩放、拖拽等功能
3. 活跃社区，问题可快速解决
4. 导出 JSON 格式天然适配后端存储

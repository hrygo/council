# 从 70% 到 100%：一次人机协作完善系统架构的实战复盘

> **当 AI 审计员遇上"冷血"要求**

---

## 引言

"审计员水平这么差？明明还有问题啊。"

这句来自用户的直接反馈，成为了我们这次架构优化项目的转折点。在人与 AI 的协作过程中，这种"不满意就继续深挖"的互动模式，最终将一个初始覆盖率仅 70% 的方案，打磨成了 100% 完整覆盖的生产级交付物。

---

## 故事背景

"The Council"（理事会）是一个多智能体协作系统——三位 AI（正方、反方、裁判）通过辩论来锻造高质量文档。我们的任务是将这个 Python 脚本示例迁移为系统的"开箱即用"体验。（详见[附录 A](#附录-a-the-council-系统介绍)）

**初始评估**：首轮审计得分 **70%**，主要问题：

1. 六步循环被简化为五节点
2. 历史上下文读取能力缺失
3. 备份机制被降级为可选
4. 长文本 Prompt 直接嵌入 SQL

这个结果无法接受。于是，一场"递进式审计"之旅开始了。

---

## 六轮审计：从表面走向深处

|  轮次  | 得分  | 关键发现               | 行动              |
| :----: | :---: | :--------------------- | :---------------- |
| **v1** |  70%  | 功能遗漏、SQL 嵌入问题 | 提出分层设计      |
| **v2** |  85%  | 策略调整可行性验证     | 新增 2 个技术规格 |
| **v3** |  92%  | 数据注入方式不一致     | 统一技术方案      |
| **v4** | 98.6% | UI 交互未定义          | 补充细节规格      |
| **v5** | 98.6% | 代码层类型定义缺失     | 新增架构修复规格  |
| **v6** | 100%  | 文档覆盖不全           | 补齐文档规范      |

### 转折点

第三轮审计时，用户要求"冷血无情的专家"登场。这迫使 AI 将审计深度从"文档层面"下探到"代码层面"。

结果在第五轮发现了 **5 个致命的架构缺陷**——如果不修复，系统将在运行时直接崩溃。

> **教训**：仅审查文档是不够的，必须交叉验证代码实现。

---

## 核心方法论：四层递进审计

```
┌────────────────────────────────────────────┐
│ Level 4: 架构层                            │
│ - 耦合度、扩展性、维护性                    │
├────────────────────────────────────────────┤
│ Level 3: 代码层                            │
│ - 类型定义、接口实现、Schema 一致性          │
├────────────────────────────────────────────┤
│ Level 2: 逻辑层                            │
│ - 数据流、状态机、一致性                    │
├────────────────────────────────────────────┤
│ Level 1: 文档层                            │
│ - 规格覆盖度、优先级、依赖                   │
└────────────────────────────────────────────┘
```

**关键原则**：每一层都不可跳过；深层问题在浅层看不到；用户的"不满意"是深入的信号。

---

## 人机协作模式

| 角色     | 职责                         | 典型动作                     |
| :------- | :--------------------------- | :--------------------------- |
| **人类** | 方向把控、质量审核、决策确认 | "再审一遍"、"写入规格"       |
| **AI**   | 数据收集、分析对比、文档生成 | 生成报告、创建规格、编写代码 |

**有效交互指令**：
- **升级指令**："冷血无情的专家" → 触发更深层审计
- **固化指令**："写入到 specs" → 避免口头承诺遗忘
- **挑战指令**："明明还有问题" → 防止过早满足

> 最佳模式：**人督促，AI 深挖，人确认，AI 固化**。

---

## 最佳实践清单

| ✅ 应该做的   | ❌ 应该避免的 |
| :----------- | :----------- |
| 多轮迭代审计 | 一次性审计   |
| 问题即时固化 | 仅审文档     |
| 代码交叉验证 | 混合技术方案 |
| 分阶段交付   | 硬编码配置   |
| 依赖图可视化 | 忽略类型约束 |

---

## 成果数据

| 指标         |       数值       |
| :----------- | :--------------: |
| 审计迭代次数 |     **6 轮**     |
| 问题发现总数 |    **19 个**     |
| 覆盖率提升   |  70% → **100%**  |
| 工时调整     | +73% (19h → 33h) |
| 技术规格文档 |     **9 份**     |

---

## 方法论一句话总结

> **"递进审计 + 即时固化 + 代码交叉验证 + 分层解耦"**

适用于：原型到产品的升级、遗留系统改造、"参考实现"转"产品级功能"。

---

## 结语

当用户说"审计员水平这么差"的时候，正确的响应不是解释，而是**继续深挖**。

正是这种"不满意就继续"的互动模式，将一个 70% 的半成品，打磨成了 100% 的完整交付。

---

## 附录 A: The Council 系统介绍

### 核心理念

> **利用对抗性思维作为质量杠杆，让多个 AI 通过辩论来锻造高质量的决策文档。**

### 三位 AI 角色

| 角色     | 代号           | 使命       | 模型配置         |
| :------- | :------------- | :--------- | :--------------- |
| **正方** | Value Defender | 为方案辩护 | Gemini (T=0.9)   |
| **反方** | Risk Auditor   | 挑战方案   | DeepSeek (T=0.6) |
| **裁判** | Chief Justice  | 综合裁决   | GLM-4.6 (T=0.2)  |

**设计原则**：
- 正方："拒绝彩虹屁"，每个论点必须回答"对全局目标有何实质贡献"
- 反方："直击痛点"，严禁建设性批评的伪装
- 裁判："拒绝各打五十板"，必须明确指出最佳路径

### 六步迭代循环

```
Step 1: 压缩历史 → Step 2: 召开理事会 → Step 3: 一致性验证
                                              ↓
Step 6: 状态更新 ← Step 5: 精准手术 ← Step 4: 快照备份
```

### 迁移挑战

| 陷阱         | 说明                          |
| :----------- | :---------------------------- |
| **来源复杂** | 12 个文件：Prompt、脚本、配置 |
| **目标严格** | 100% 覆盖六步循环             |
| **架构约束** | 骨架不能耦合业务逻辑          |
| **技术差异** | Python → Go + React           |

---

*本文基于 Council Platform Sprint 6 项目实践提炼。*

# 产品需求文档 (PRD): The Council (理事会)

| 文档属性       | 内容                                                          |
| -------------- | ------------------------------------------------------------- |
| **产品名称**   | The Council (理事会)                                          |
| **版本号**     | **v1.2.0 (MVP_Simplified)**                                   |
| **文档状态**   | **✅ 已定稿**                                                  |
| **核心定位**   | 可视化的多智能体协作决策系统 & 个人私有智库                   |
| **目标用户**   | 有技术背景的创业者、管理者、高管 (Power Users)                |
| **适用平台**   | Web Application (浏览器访问)                                  |
| **技术栈核心** | Go (Backend API) + React (Frontend SPA) + PostgreSQL (Docker) |

---

## 1. 产品愿景 (Product Vision)

打造一个**"思维外脑容器"**。用户不再是孤独的决策者，而是"理事会"的主席。通过可视化的工作流编排，用户可以组建不同的"群组"（如创业项目群、家庭事务群），指挥 3 个 AI 专家针对提案（想法或文件）进行深度协作、辩论与评审，并将产生的智慧沉淀为长期的私有知识资产。

---

## 2. 概念模型 (Conceptual Model)

为了明确产品逻辑，定义以下核心实体关系：

1. **理事会群组 (Group)**：最高层级的容器。代表一个具体的业务场景（如"SaaS项目组"）。拥有独立的"宪法"（定位提示词）和隔离的"群记忆"。
2. **理事 (Agent)**：AI 角色卡。拥有独立的"人设"和"个人记忆"。可以被多个群组复用。
3. **提案 (Proposal)**：用户输入的一次性任务，包含文本说明或附件（PDF/MD）。
4. **流程 (Workflow)**：定义会议如何进行的有向无环图（DAG），由不同功能的节点组成。
5. **会议 (Session)**：流程的一次具体运行实例。

---

## 3. 功能需求说明 (Functional Requirements)

### 3.1 核心模块：群组管理体系 (Groups System)

**目标**：实现场景隔离，确保 AI 在正确的上下文中工作。

* **F.1.1 创建/管理群组**
  * **基础信息**：群名称、群图标。
  * **群定位 (System Prompt)**：定义该群的底层逻辑与价值观。
    * *示例*："本群专注于 Go 语言后端架构，风格务实，拒绝过度设计，优先考虑运维成本。"
  * **默认班底 (Default Members)**：从 Agent 库中选择 3 位作为该群的默认常驻理事（启动会议时自动加载，可临时更换）。

* **F.1.2 群记忆隔离**
  * 该群产生的所有文档、对话记录、结论，仅在当前 `Group_ID` 下可被检索，严禁跨群泄露（除非用户手动迁移）。

### 3.2 核心模块：AI 理事工厂 (Agent Factory)

**目标**：提供灵活、可复用、模型无关的角色配置。

* **F.2.1 角色定义**
  * **基本属性**：名称、头像、职业描述。
  * **人设提示词 (Persona Prompt)**：定义性格、语气、思维框架、专业领域。

* **F.2.2 模型配置 (Model Agnostic)**
  * **多供应商支持**：OpenAI, Anthropic, Google, DeepSeek 等云端 API。
    * *注*：本版本专注云端服务，以确保最佳性能和并发体验。
  * **独立配置**：用户可为**每一个 Agent** 单独指定模型供应商及版本。
    * *场景*：CFO 角色绑定 `Claude-3.5-Sonnet` (逻辑强)；气氛组角色绑定 `gpt-4o-mini` (低成本)。
  * **参数微调**：支持配置 Temperature (创造力), Top_P, Max Tokens。

* **F.2.3 能力开关 (Capabilities Toggle)**
  * **联网搜索**：MVP 阶段**核心必选**，默认状态为 `Enabled`。集成 Tavily/Serper API，用于事实核查和信息检索。
  * **代码执行**：MVP 阶段 UI 预留开关，默认状态为 `Disabled`（Phase 2 启用）。

### 3.3 核心模块：可视化流程编排 (Workflow Canvas)

**目标**：将"开会"变为可编程的工作流。

* **F.3.1 节点编辑器**
  * 基于 React Flow / X6 的无限画布交互。
  * **支持节点类型**：
    * 🟢 **Start (提案)**：输入起点，支持挂载 PDF/MD 文件。
    * 🟦 **Agent Node (发言)**：绑定一个 AI 角色，定义其输入源（上一节点的输出）。
    * 🔶 **Logic Node (逻辑)**：
      * `Parallel` (并行)：分支节点，下游的多个 Agent 同时思考/发言。
      * `Sequence` (串行)：按顺序依次发言。
      * `Vote` (表决)：强制 Agent 输出结构化结论 (Yes/No/Score)，支持设置通过阈值。
      * `Loop` (循环)：设定辩论轮次（如：互相反驳 3 轮）。
      * `Loop` (循环)：设定辩论轮次（如：互相反驳 3 轮）。
      * `FactCheck` (事实核查) 🆕：调用搜索工具验证前序 Agent 的断言，阻断集体幻觉。支持 **联网搜索** 和 **本地知识库 (Local KB)** 检索。
      * `HumanReview` (人类裁决) 🆕：**强制性**的"人机回环"节点。暂停流程，生成"决策草案"，等待用户确认/修改后方可继续。
    * 🔴 **End (总结)**：输出最终报告，结束流程。

* **F.3.2 模版库 (Template Library)**
  * **保存模版**：将当前画布保存为命名模版（如"严格代码评审"、"商业计划书压力测试"）。
  * **调用模版**：在群组内发起新提案时，强制要求先选择一个流程模版。
  * **系统预置模版**（强制包含事实核查与人类裁决）：
    * 代码评审：Start → Parallel(安全/性能/可维护性) → Vote → HumanReview → End
    * 商业计划压测：Start → Loop(魔鬼代言人 3轮) → FactCheck → Vote → HumanReview → End
    * 快速决策：Start → Parallel(正/反/中立) → FactCheck → Vote → HumanReview → End

* **F.3.3 向导模式 (Wizard Mode)** 🆕
  * **自然语言生成流程**：用户输入"帮我设计一个严格的代码评审流程"，系统自动生成 DAG 图。
  * **模版推荐**：基于用户描述，智能推荐相似的系统预置模版。
  * **模版推荐**：基于用户描述，智能推荐相似的系统预置模版。
  * **可编辑输出**：生成的流程可在 Canvas 中二次编辑调整。

* **F.3.4 UI 降噪与上帝模式 (God Mode)** 🆕
  * **默认降噪**：隐藏 `Temperature`, `Top_P` 等技术参数，仅保留自然语言指令输入。
  * **上帝模式**：在设置中开启后，显示所有 Agent 的详细模型参数配置面板，供 Power User 微调。

### 3.4 交互体验：弹性会议室 (Flexible Meeting Room)

**目标**：三分布局，弹性可变，支持不同专注模式。

* **F.4.0 弹性布局框架 (Flexible Layout)**
  * **默认视图**：首次进入默认收起左侧工作流画布，仅展示 中(对话) + 右(文档) 双栏。
  * **高级模式**：点击"显示工作流"按钮展开左侧画布（适合 Power User）。
  * **默认比例**：左(20%) : 中(50%) : 右(30%)。
  * **拖拽调整 (Resizable)**：所有栏位分割线支持拖拽，实时调整宽度。
  * **折叠/展开 (Collapsible)**：左侧和右侧栏位可收起至边缘图标栏。
  * **全屏专注 (Maximize)**：任意栏位可点击"全屏"按钮，进入沉浸模式。
  * **状态记忆**：记住用户最后一次的布局设置。

* **F.4.1 左侧栏：流程监控**
  * 只读模式显示当前运行的流程图。
  * **状态同步**：当前正在思考/发言的节点高亮闪烁，显示 Token 消耗预估。

* **F.4.2 中间栏：结构化对话流**
  * **分节显示**：对话流按"流程节点"分块（如"阶段1：初步审查"），而非线性混排。
  * **并行 UI**：若处于并行节点，多个 Agent 的气泡在同一行**并排显示**。
  * **Markdown渲染**：支持代码块、表格、公式。

* **F.4.3 右侧栏：文档与上下文**
  * **文档阅读器**：展示用户上传的 PDF/MD。
  * **双向索引**：AI 发言中引用原文处显示连接 `[Ref: P3]`，点击后文档自动滚动至对应段落并高亮。

* **F.4.4 成本预估模块 (Cost Estimator)** 🆕
  * 在点击"开始会议"前，根据选定模型和流程复杂度显示预估成本：
    * 示例："本次会议预计消耗 ~$0.35，耗时 ~2 分钟"
  * 用户可选择继续或更换更经济的模型配置，避免"账单刺客"。

### 3.5 核心引擎：双层记忆与 RAG (Dual-Layer Memory)

**目标**：越用越懂用户的第二大脑。

* **F.5.1 记忆写入 (Ingestion)**
  * 会议结束时，系统自动运行"萃取进程"，将关键结论切片向量化。
  * **打标逻辑 (Tags)**：
    1. `Group_ID` (项目维度)
    1. `Group_ID` (项目维度)
    2. `Agent_Type` (角色维度)

* **F.5.3 记忆清洗 (Memory Sanitation)** 🆕
  * **会议复盘**：会议结束后，用户可进入"复盘模式"。
  * **纠错机制**：用户可手动标记某些结论为"无效"或"错误"，系统将在向量库中对其进行软删除或打上负面标签，防止其在未来的检索中被错误引用。

* **F.5.2 记忆检索 (Context Injection)**
  * AI 思考时，Prompt Context 会自动按优先级拼接：
    1. **群定位** (System Prompt)
    2. **人设** (Persona Prompt)
    3. **群相关记忆** (RAG Search with `group_id`)
    4. **角色经验记忆** (RAG Search with `agent_type`)
    5. **当前提案内容**

---

## 4. 非功能需求 (Non-Functional Requirements)

* **隐私性 (Privacy)**：
  * **数据安全**：所有数据存储在用户自有 Docker PostgreSQL 中，不上传至第三方服务器。
  * **Key Management**：API Key 必须加密存储（Browser Secure Storage / 环境变量）。

* **性能 (Performance)**：
  * 后端使用 **Go Goroutines** 处理，必须支持 3 个 Agent 并发生成。
  * 前端使用 WebSocket 接收流式数据，首字延迟 < 500ms。

* **扩展性 (Extensibility)**：
  * API 设计需遵循 OpenAI Function Calling 标准，为未来接入插件做准备。
